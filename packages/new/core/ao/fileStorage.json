{
    "lists": {},
    "forms": {
        "fileStorageTask": {
            "title": "Хранилище файлов",
            "className": "vertical task task-panel",
            "style": {
                "height": "100%",
                "overflow": "hidden"
            },
            "$": {
                "@taskBar": {
                    "className": "horizontal",
                    "$": {
                        ".ap": {
                            "control": "ActionPanel",
                            "controlOpts": {
                                "actions": [
                                    {
                                        "title": "Refresh",
                                        "mini": true,
                                        "icon": "refresh",
                                        "action": {
                                            "js": "task.events.fire('refreshDir');"
                                        }
                                    },
                                    {
                                        "title": "Upload",
                                        "upload": true,
                                        "action": [
                                            {
                                                "js": "backend.post('/aoa/execObjectMethod', {object: 'fileStorage', method: 'uploadFile', file: params.file}, {isFormData: true})"
                                            }
                                        ]
                                    },
                                    {
                                        "title": "Delete",
                                        "mini": true,
                                        "icon": "delete",
                                        "confirm": {
                                            "message$": "`Delete file ${context.listContext.selectedRow.name}`"
                                        },
                                        "action": [
                                            {
                                                "js": "return backend.post('/aoa/execObjectMethod', {object: 'fileStorage', method: 'deleteFile', params: {name: context.listContext.selectedRow.name}})"
                                            }
                                        ],
                                        "disabled$": "!context.listContext?.selectedRow"
                                    }
                                ]
                            }
                        }
                    }
                },
                ".files": {
                    "style": {
                        "flexGrow": 1
                    },
                    "control": "ListTable",
                    "controlOpts": {
                        "id": "filePath",
                        "rowModelType": "serverSide",
                        "columns!": {},
                        "groupColumns!": {
                            "name": {
                                "label": "Наименование",
                                "width": 280,
                                "flex": 1
                            }
                        },
                        "getDataPath": "data.path",
                        "refreshEvent": "refreshDir"
                    },
                    "controlProps": {
                        "style": {
                            "height": "100%"
                        },
                        "listContext$": "context.listContext || (()=>{context.listContext={}; return context.listContext;})()",
                        "gridOptions": {
                            "domLayout": "normal",
                            "treeData": true,
                            "groupDefaultExpanded": -1
                        }
                    },
                    "actions": {
                        "onSelectionChanged": {
                            "name": "onRefresh"
                        },
                        "onGetRows": [
                            {
                                "js": "console.log('onGetRows', arguments['0'])"
                            },
                            {
                                "js": "return backend.post('/aoa/execObjectMethod', {object: 'fileStorage', method: 'readDir', params: {request: {...params.request}}}).then((r)=>{onSuccess(r)})"
                            }
                        ]
                    }
                }
            },
            "actions": {
                "onRefresh": {
                    "js": ";"
                }
            }
        }
    },
    "js": {},
    "methods": {
        "readDir": {
            "sql": {
                "sql": ""
            },
            "script": {
                "py": "from django.conf import settings\nimport os\n\nworkcopy_prefix = getattr(settings, 'AOS_WORKCOPY_PATH', None)\nif not workcopy_prefix:\n    raise Exception('Invalid setup: AOS_WORKCOPY_PATH')\n\n(root, dirs, files) = next(os.walk(workcopy_prefix))\n\ndata = []\nfor d in dirs:\n    data.append({\n        'filePath': os.path.join(root, d),\n        'isDir': True,\n        'name': d,\n    })\n    \nfor f in files:\n    data.append({\n        'filePath': os.path.join(root, f),\n        'name': f,\n    })\n\n"
            }
        },
        "uploadFile": {
            "script": {
                "py": "from django.conf import settings\nimport os\n\nworkcopy_prefix = getattr(settings, 'AOS_WORKCOPY_PATH', None)\nif not workcopy_prefix:\n    raise Exception('Invalid setup: AOS_WORKCOPY_PATH')\n\n\n\nfile = parameters['$files'].get('file')\nfile_path = os.path.join(workcopy_prefix, file.name)\n\nwith open(file_path,'wb') as f:\n    f.write(file.read())\n\n"
            }
        },
        "deleteFile": {
            "script": {
                "py": "from django.conf import settings\nimport os\n\nworkcopy_prefix = getattr(settings, 'AOS_WORKCOPY_PATH', None)\nif not workcopy_prefix:\n    raise Exception('Invalid setup: AOS_WORKCOPY_PATH')\n\nfile_path = os.path.join(workcopy_prefix, parameters['name'])\n\nos.remove(file_path)\n"
            }
        }
    },
    "references": {}
}