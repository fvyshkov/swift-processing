<workflow id="KATM_CANCEL" name="АСОКИ. Отмена заявки">
    <event name="onGetProcessObject">
        <![CDATA[
ok = process_vars.get('objectKey')

# Из объекта получаем идентификаторы заявки    
kv = ok.split(':')
pk = kv[1].split(',')

#
# Загружаем общую информацию по заявке
#
from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    from apng_core.aoa.services import execObjectMethod
    token._po = execObjectMethod({
        'object': 'app', 'method': 'getApplication',
        'params': {
            'dep_id': int(pk[0]),
            'id'    : int(pk[1]),
        }
    })
]]>
    </event>
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <script id="55ecc4c7-ccc7-4053-b653-13965614003f" name="Отмена заявки в КАТМ">
        <![CDATA[from apng_core.csl import Csl
from colvir_cbs.auth import AuthenticatedUser
from datetime import datetime
import traceback

pv['last_error'] = None

try:
    request = {
        # Номер заявки
        'claim_id'  : pv['claim_id'],
        # Дата отказа 
        'date'      : datetime.now(),
        # Номер документа отказа
        'number'    : pv['claim_id'],
        # Причина (код)
        'reason'    : '8',
        # Причина отказа текст, примечание
        'note'      : 'Отказ заёмщика'
    }

    with Csl('CSL_APP_URL') as csl:
        response = csl.request(
            '/KATMService/DeclineClaim',
            request
        )
        
        if response.status_code != 200:
            pv['last_error'] = csl.extractLastError()
            
except Exception as e:
    raise UserException({
        'message': 'Ошибка вызова сервиса отмены заявки в АСОКИ\n%s' % e,
        'trace': traceback.format_exc()
    })
]]>
    </script>
    <split id="a3bf0cd8-396d-4d7a-a8cd-40f78bb6deee" name="Результат запроса">
        <condition id="cb7dbdcd-a09b-4874-9953-3cab81aa3091" name="Успешно" expression="process_vars[&apos;last_error&apos;] is None">
            <script id="0618d483-a860-4b05-b257-221f214599b2" name="Журнализация отмены">
                <journal time="leave">
                    <![CDATA[Заявка {{pv.claim_id}} отменена в АСОКИ]]>
                </journal>
                <![CDATA[
                
            ]]>
            </script>
        </condition>
        <condition id="df404114-a584-4b52-afcf-1de5ea42f790" name="Ошибка" expression="process_vars[&apos;last_error&apos;] is not None">
            <task id="a37b30f6-fc00-4f53-a388-6c9c556fac46" name="Показ ошибки отмены" autoStart="true" description="Ошибка отмены заявки в АСОКИ, заявка {{process_vars.claim_id}}">
                <clientTask path="/easyflow/error-dialog" taskName="{{task.description}}">
                    <p name="error" expression="process_vars[&apos;last_error&apos;]"/>
                    <p name="actions" expression="[  { &apos;name&apos;: &apos;Повторить&apos;, &apos;value&apos;: &apos;repeat&apos; }, { &apos;name&apos;: &apos;Пропустить&apos;, &apos;value&apos;: &apos;skip&apos; } ]"/>
                    <p name="actionVar" expression="&apos;action&apos;"/>
                </clientTask>
            </task>
            <split id="e91119d2-a84b-4491-b318-0e338f0d415a" name="Выбор пользователя">
                <condition id="98544cdf-4f8b-4c3f-89fa-095b3ecf7e99" name="Повторить" expression="process_vars[&apos;action&apos;] == &apos;repeat&apos;">
                    <jump id="90af8b79-8354-4608-b8e3-58442e9d7a4b" name="Переход к Отмена заявки в КАТМ" target_id="55ecc4c7-ccc7-4053-b653-13965614003f"/>
                </condition>
                <condition id="af676a7e-ecbb-497f-8f49-f44d891ccefc" name="Пропустить" expression="process_vars[&apos;action&apos;] == &apos;skip&apos;">
                    <script id="5aea2e8d-9115-40ea-b83d-6629f9982d8b" name="Журнализация">
                        <journal time="leave">
                            <![CDATA[Заявка {{pv.claim_id}} не отменена в АСОКИ из за ошибок]]>
                        </journal>
                    </script>
                </condition>
            </split>
        </condition>
    </split>
</workflow>