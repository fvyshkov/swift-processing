<workflow id="APP_REJECT_EXT" name="Регистрация отказа во внешних сервисах">
    <script id="init" name="Инициализация">
        <![CDATA[
ok = process_vars.get('objectKey')
if not ok:
    ok = 'loanapp:1855,1287412'
    process_vars['objectKey'] = ok
    #raise Exception('Не задан ключ объекта для запуска сценария, objectKey');
    
kv = ok.split(':')
pk = kv[1].split(',')
process_vars['dep_id'] = int(pk[0])
process_vars['id'] = int(pk[1])
    

from apng_core.aoa.services import execObjectMethod
process_vars['appSettings'] = execObjectMethod({
    'object': 'settings',
    'method': 'get'
})['loanapp']
]]>
    </script>
    <parallel id="registration" name="Регистрация">
        <flow id="register_niki" name="Регистрация отказа заявки в НИКИ">
            <split id="fc47ddbf-3195-4a2a-a7b6-4f487d5e2033" name="Эмуляция ГРКИ">
                <condition id="42111076-bfcf-4881-9913-b2b2c4d3316b" name="Да" expression="process_vars[&apos;appSettings&apos;][&apos;grki&apos;][&apos;emulator&apos;]">
                    <script id="9aaf1d68-0aa3-4b67-8684-90d824aac746" name="Эмуляция отказа ГРКИ">
                        <journal time="leave">
                            <![CDATA[Связь с ГРКИ отключена]]>
                        </journal>
                        <![CDATA[
                        
                    ]]>
                    </script>
                </condition>
                <condition id="92c400cf-e18f-496b-b298-2083fa46b9db" name="Нет" expression="not process_vars[&apos;appSettings&apos;][&apos;grki&apos;][&apos;emulator&apos;]">
                    <call id="register_niki_process" name="Регистрация отказа в ГРКИ офлайн" call="&apos;NIKI_REJECT&apos;" condition="process_vars[&apos;appSettings&apos;][&apos;grki&apos;][&apos;offline&apos;]" result_from="niki_state" result_to="niki_state">
                        <p name="objectKey" expression="process_vars[&apos;objectKey&apos;]"/>
                        <p name="req" expression="None"/>
                        <p name="decision_registered" expression="process_vars.get(&apos;decision_registered&apos;)"/>
                    </call>
                    <call id="215b79fb-91da-4324-a185-31fb92906064" name="Регистрация отказа в ГРКИ онлайн" call="&apos;NIKI_REJECT_ONLINE&apos;" condition="process_vars.get(&apos;niki_state&apos;, {&apos;status&apos;: &apos;success&apos;}).get(&apos;status&apos;) == &apos;success&apos; and process_vars.get(&apos;appSettings&apos;) and process_vars[&apos;appSettings&apos;].get(&apos;grki&apos;) and process_vars[&apos;appSettings&apos;][&apos;grki&apos;][&apos;online&apos;]" result_from="nikiState" result_to="nikiStateOnline"/>
                </condition>
            </split>
        </flow>
        <flow id="register_katm" name="Регистрация отказа заявки в КАТМ">
            <split id="fb4e64e9-52fb-437c-98ec-a39e3d167c23" name="Эмуляция КАТМ">
                <condition id="2dc5d568-4a5a-424d-932f-0c13c5ab3d90" name="Да" expression="process_vars[&apos;appSettings&apos;][&apos;katm&apos;][&apos;emulator&apos;]">
                    <script id="f2f552df-62a0-432c-bc4f-460841be17d9" name="Эмуляция отказа КАТМ">
                        <journal time="leave">
                            <![CDATA[Связь с КАТМ отключена]]>
                        </journal>
                    </script>
                </condition>
                <condition id="a9ecc5fe-3f93-4b21-8818-2a2fc83fa227" name="Нет" expression="not process_vars[&apos;appSettings&apos;][&apos;katm&apos;][&apos;emulator&apos;]">
                    <call id="register_katm_process" name="Регистрация отказа в КАТМ" call="&apos;KATM_REJECT&apos;" result_from="katm_result" result_to="katm_result">
                        <p name="objectKey" expression="process_vars[&apos;objectKey&apos;]"/>
                        <p name="req" expression="process_vars.get(&apos;req&apos;)"/>
                        <p name="decision_registered" expression="process_vars.get(&apos;decision_registered&apos;)"/>
                    </call>
                </condition>
            </split>
        </flow>
    </parallel>
    <script id="rgister_ext_result" name="Журнализация результата">
        <journal time="leave">
            <![CDATA[Регистрация отказа заявки во внешних системах выполнена]]>
        </journal>
    </script>
</workflow>