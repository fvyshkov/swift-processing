<workflow id="APP_RENEW_ID" name="Генерация нового уникального номера заявки">
    <script id="b43d3086-a60b-4772-b01f-de1095b2ec36" name="Генерация нового номер">
        <journal time="leave">
            Изменен id заявки с {{process_vars.oldId}} на {{process_vars.newId}}
        </journal>
        <![CDATA[ok = process_vars.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')
process_vars['dep_id'] = int(pk[0])
process_vars['id'] = int(pk[1])

from django.db import transaction
from colvir_cbs.auth import AuthenticatedUser
from colvir_cbs.services import application as app

with transaction.atomic(using='cbs'):

    with AuthenticatedUser() as au:
        with au.getConnection().cursor() as cursor:
            p = {
                #'dep_id': process_vars['dep_id'],
                #'id': process_vars['id'],
                'newId': cursor.var(int),
            }
            
            p['newId'].setvalue(0, None)
            
            cursor.execute("""
                declare
                    newId number;
                begin
                    select L_UZ_UNIQNUMREQ_KEY.nextval into newId from dual;
                    
                    :newId := newId;
                end;
            """, p)

        j = app.getApplicationJson({'dep_id': process_vars['dep_id'], 'id': process_vars['id']})
        
        process_vars['oldId'] = j['app']['appId']
        process_vars['newId'] = p['newId'].getvalue()
        
        j['app']['appId'] = process_vars['newId']
        app.saveApplicationJson({'dep_id': process_vars['dep_id'], 'id': process_vars['id'], 'json': j})
        

]]>
    </script>
</workflow>