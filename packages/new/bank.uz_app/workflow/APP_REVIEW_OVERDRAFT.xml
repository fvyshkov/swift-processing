<workflow id="APP_REVIEW_OVERDRAFT" name="Рассмотрение заявки. овердрафт">
    <event name="onGetProcessObject">
        <![CDATA[ok = process_vars.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')

from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    from apng_core.aoa.services import execObjectMethod
    token._po = execObjectMethod({
        'object': 'app', 'method': 'getApplication',
        'params': {
            'dep_id': int(pk[0]),
            'id'    : int(pk[1]),
        }
    })
]]>
    </event>
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <script id="29de0ea3-b875-4d9c-9468-8665666108e3" name="Инициализация">
        <journal time="leave">
            <![CDATA[Начало обработки заявки {{po.app.code}}, {{po.client.name}}]]>
        </journal>
        <![CDATA[pv['skip_scoring'] = False

pv['SCORE_THREHOLD'] = 55

ok = pv.get('objectKey')

kv = ok.split(':')
pk = kv[1].split(',')
pv['dep_id'] = int(pk[0])
pv['id'] = int(pk[1])

]]>
    </script>
    <script id="449546e1-f0b1-4c6a-80cb-dc54ff8d54d0" name="Состояние заявки: на рассмотрении">
        <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.aoa.services import execObjectMethod


with AuthenticatedUser() as au:
    execObjectMethod({
        'object': 'app', 'method': 'setState',
        'params': {
            'dep_id': pv['dep_id'],
            'id': pv['id'],
            'state': 'ON_REVIEW',
            'stage': 'START',
        }
    })

]]>
    </script>
    <timer id="a1b694bd-2718-44ec-b79f-558e9a8fc81d" name="Таймер, 0сек" description="Обработка заявки {{po.app.code}}" duration="00:00:00" errorDuration="00:01:00" action="continue">
        <scriptBefore>
            <![CDATA[#
# Продолжение сценария может быть долгим
# лимит стека нужно поднять
#
import sys
sys.setrecursionlimit(4000)]]>
        </scriptBefore>
    </timer>
    <script id="89eeee40-1639-453e-9970-544c531eaac9" name="Информирование клиента о начале рассмотрения заявки">
        <journal time="leave">
            <![CDATA[Информирование клиента, SMS: {{po.client.phone}}]]>
        </journal>
    </script>
    <call id="4cc569be-8f7f-4266-acaf-6e1134e4b332" name="Контроль ввода заявки" call="&apos;APP_CHECK_PLEDGE&apos;" result_from="result" result_to="app_check_result"/>
    <split id="815b41ce-d19a-4c12-9379-478dd089c522" name="Результат контроля ввода заявки">
        <condition id="0bd4ee84-266b-4f8b-9f6d-2da7add43d5d" name="В доработку" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="d654654a-610c-4ee8-aa34-7d7a6100207b" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],   &apos;id&apos;: pv[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="1971a94f-c838-40e5-a421-4556dd208015" name="Переход к Таймер, 0сек" target_id="a1b694bd-2718-44ec-b79f-558e9a8fc81d"/>
        </condition>
        <condition id="9d3e0961-5ae5-41ed-8733-0e15776af70d" name="Продолжить" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;accept&apos;"/>
        <condition id="29a5e854-7a61-49e3-8c9e-ccd9cef55d89" name="Отказать" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;decline&apos;">
            <timer id="836f70f4-6236-4f0b-a2e4-79dd48c338c3" name="Таймер, регистрация во внешних системах" description="Обработка заявки {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
            <call id="412d6242-a02f-456a-9752-ea19a563f402" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT"/>
            <split id="513c2739-6e8a-49e9-993d-4a24e253bf32" name="Результат регистрации">
                <condition id="4be45e70-3a97-4371-8bc6-caea20ac08d7" name="Успешно"/>
                <condition id="5ce95afe-55b3-41cd-85b8-cbebce64867b" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
                    <task id="7b3d040b-98c1-489b-beae-cb6382d04116" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                        <journal time="leave">
                            <![CDATA[{{task.description}}]]>
                        </journal>
                        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                            <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],   &apos;id&apos;: pv[&apos;id&apos;] }"/>
                            <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                            <p name="readOnly" expression="False"/>
                            <p name="object" expression="&apos;app&apos;"/>
                            <p name="form" expression="&apos;appEditTask&apos;"/>
                        </clientTask>
                    </task>
                    <jump id="63144565-90d9-4230-8d2b-2acda510085f" name="Переход к Таймер, регистрация во внешних системах" target_id="836f70f4-6236-4f0b-a2e4-79dd48c338c3"/>
                </condition>
            </split>
            <script id="d84a5281-46f7-4c6a-bc5a-6c53cb7de3ba" name="Установка отказа по контролю обеспечения">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

process_vars['decision'] = {
    'app_result': 'REJECT',
    'agency_code': '01',
    'agency_decision_code': '0',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать. Не достаточно обеспечения.',                 
    'decline_reason_code': '08',
    'show_dialog': False,
}
]]>
            </script>
            <jump id="1fdf7177-2430-43f6-9c58-75d6608c9eae" name="Переход к Обработка решения по заявке" target_id="e67c4984-4802-4896-a2a4-790961082eda"/>
        </condition>
    </split>
    <call id="b716cd96-f0c3-4bbc-b7c4-24d47c19fc55" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT"/>
    <split id="23d0855c-7c05-4b9e-89c3-3af40270faa5" name="Статус регистрации заявки">
        <condition id="0403f6aa-3c5d-4473-8e55-2a6e23f09c1c" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="3a726d86-34af-4281-828a-5eff7713b284" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],  &apos;id&apos;: pv[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="2feb72d4-ca51-44cf-bffb-2cc523fe0dce" name="Переход к Таймер, 0сек" target_id="a1b694bd-2718-44ec-b79f-558e9a8fc81d"/>
        </condition>
        <condition id="bde7fd00-49c7-4441-a8e6-276f8e319157" name="Успешно"/>
    </split>
    <call id="7ace8973-b2c0-4223-a057-5d8bd6fa05a4" name="Передача заявки в АФС" call="&apos;APP_TO_AFS&apos;"/>
    <call id="cc0130dd-03fd-4c45-aeee-450a2105c537" name="Расчет стоп факторов 1" call="&apos;APP_STOP_FACTORS_1&apos;" result_from="SF1_status" result_to="SF1_status"/>
    <split id="d0ec2097-75bc-4946-be96-215b76eb38e0" name="Обработка стоп факторов 1">
        <condition id="d31a697c-6957-4d96-94f4-0520e4627dbe" name="СФ1 пройдены" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;accept&apos; or po.get(&apos;skipSF1&apos;, False) == True"/>
        <condition id="d28ff01b-8b5f-40d4-96ba-970863d02859" name="СФ1 не пройдены" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;decline&apos; and po.get(&apos;skipSF1&apos;, False) == False">
            <script id="192407ae-3550-4ec1-85af-eb7734981e64" name="Установка отказа по СФ1">
                <![CDATA[from datetime import datetime
from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

if not decision_date:
    decision_date = datetime.now()

pv['decision'] = {
    'decision': 'decline',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать. Наличие стоп факторов.',
    'declineReason': '',
    'show_dialog': False,
}


            ]]>
            </script>
            <jump id="f97ff79e-b1cc-4572-86ff-015141abaf3d" name="Переход к Обработка решения по заявке" target_id="e67c4984-4802-4896-a2a4-790961082eda"/>
        </condition>
    </split>
    <call id="6e9b0b54-03d6-4f67-ac36-83fd9f8769eb" name="Расчет стоп факторов 2" call="&apos;APP_STOP_FACTORS_2&apos;" result_from="SF2_status" result_to="SF2_status"/>
    <split id="524d2f17-0844-4266-80a1-9339589c7bbf" name="Обработка стоп факторов 2">
        <condition id="2113ea8a-201d-4daa-8075-152568a1a264" name="СФ2 не пройдены" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] == &apos;decline&apos; and po.get(&apos;skipSF2&apos;, False) == False">
            <script id="3da73f72-bf81-4248-ac24-7b25f4253043" name="Установка отказа по СФ2">
                <![CDATA[from datetime import datetime
from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday
    
if not decision_date:
    decision_date = datetime.now()

pv['decision'] = {
    'decision': 'decline',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать. Наличие стоп факторов.',
    'declineReason': '',
    'show_dialog': False,
}


            ]]>
            </script>
            <jump id="9d5cc4fe-b0de-450a-8c03-80301a444937" name="Переход к Обработка решения по заявке" target_id="e67c4984-4802-4896-a2a4-790961082eda"/>
        </condition>
        <condition id="49d86285-a1f3-4008-9741-33f2f5bcec5e" name="СФ2 пройдены" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] in (&apos;accept&apos;, &apos;altAmount&apos;, &apos;altAmountScoring&apos;) or po.get(&apos;skipSF2&apos;, False) == True"/>
    </split>
    <script id="b5b0a950-147a-43cd-91e8-e191c62d06c7" name="Установка положительного решения">
        <![CDATA[from apng_core.easyflow.auth import Authentication
from datetime import datetime

decision_date = Authentication.getAuthenticatedUser().operday
if not decision_date:
    decision_date = datetime.now()

pv['decision'] = {
    'decision': 'accept',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Разрешить',
    'declineReason': '',
    'show_dialog': False,
}

]]>
    </script>
    <call id="e67c4984-4802-4896-a2a4-790961082eda" name="Обработка решения по заявке" call="&apos;APP_REVIEW_FIN&apos;">
        <p name="decision" expression="pv.get(&apos;decision&apos;)"/>
    </call>
    <script id="8a91f2f1-4dce-4d62-9345-1f760f528694" name="Стадия рассмотрения: завершено">
        <![CDATA[from apng_core.aoa.services import execObjectMethod
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser() as au:
    execObjectMethod({
        'object': 'app', 'method': 'setState',
        'params': {
            'dep_id': pv['dep_id'],
            'id': pv['id'],
            'stage': 'COMPLETED',
        }
    })
]]>
    </script>
</workflow>