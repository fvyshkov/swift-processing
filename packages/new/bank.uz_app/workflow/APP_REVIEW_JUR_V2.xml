<workflow id="APP_REVIEW_JUR_V2" name="Кредитная заявка юридических лиц v2">
    <event name="onGetProcessObject">
        <![CDATA[ok = process_vars.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')

from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    from loanapp.services.application import getApplication
    with AuthenticatedUser():
        token._po = getApplication({
            'dep_id': int(pk[0]),
            'id'    : int(pk[1]),
        })
        token._po['dep_id'] = int(pk[0])
        token._po['id'] = int(pk[1])
]]>
    </event>
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <script id="6f041334-76b6-4671-af00-1fb174bf931f" name="Инициализация">
        <journal time="leave">
            <![CDATA[Начало обработки заявки {{po.app.code}}, {{po.client.name}}]]>
        </journal>
        <![CDATA[#
# Проверяем и устанавливаем инициатора заявки
#
if token.process.initiator != po['user']['code']:
    #
    # Процесс запустил не пользователь, который создал заявку, поменяем
    #
    user = po['user']['code']
    token.process.initiator = user
    token.process.save()

    from apng_core.easyflow.auth import Authentication
    from apng_core.auth import ColvirUser
    Authentication.setAuthenticatedUser(ColvirUser(username=user))
        
# Зачитываание настроек
from apng_core.aoa.services import execObjectMethod
settings = execObjectMethod({'object': 'settings', 'method': 'get'})['loanapp']
pv['decisionWorkflow'] = settings['workflow']['decision'] if settings.get('workflow') and settings['workflow'].get('decision') else None


pv['asoki_requests'] = []
]]>
    </script>
    <script id="8b853e29-14ad-464d-a1bb-ce4e32f1c94f" name="Проверка возможности запуска">
        <![CDATA[#
# Наличие запущенных процессов
#
from apng_core.easyflow.models import Token

filter = {
    'objectKey': pv['objectKey'],
    'parent': None,
    'flow_id': po['app']['reviewWorkflow'],
    'state__in': ['active', 'suspended']
}

processes = Token.objects.filter(**filter).exclude(id=token.process.id)
if len(processes) > 0:
    raise UserException({
        'message': 'Заявка {appNo} уже отправлена на рассмотрении'.format(
            appNo = po['app']['code']
        )
    }) from None

]]>
    </script>
    <script id="6fe4dd58-ce8b-462a-bb03-67d0113a410f" name="Состояние заявки: на рассмотрении">
        <![CDATA[from apng_core.aoa.services import execObjectMethod
execObjectMethod({
    'object': 'app', 'method': 'setState',
    'params': {
        'dep_id': po['dep_id'],
        'id': po['id'],
        'state': 'ON_REVIEW',
        'stage': 'START',
    }
})

]]>
    </script>
    <timer id="c73d2670-d502-4568-a14b-756a8698a8d9" name="Информирование клиента о начале рассмотрения" description="Информирование клиента о начале рассмотрения заявки {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
    <script id="3da0af0c-2456-429b-a400-029d7cec0080" name="Информирование клиента о начале рассмотрения заявки">
        <journal time="leave">
            <![CDATA[Информирование клиента, SMS: {{po.client.phone}}]]>
        </journal>
    </script>
    <timer id="43bee16f-8b7e-4b60-ac5d-a3be9d22ea0e" name="Обработка заявки" description="Обработка заявки {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
    <call id="ee779899-f887-48d8-9fd2-0e91327ffa81" name="Контроль ввода заявки" call="&apos;APP_CHECK_INPUT&apos;" result_from="result" result_to="app_check_result"/>
    <split id="f974ac71-5a5a-4758-98d4-206c80e05d7c" name="Результат контроля ввода заявки">
        <condition id="2d10c9f2-796a-411d-92bd-985b76dbe6fe" name="В доработку" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="77241f32-66ee-40d9-a2f3-f5e6e7cb2e11" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <event name="onComplete">
                    <![CDATA[# Сбросим ссылку на объект, если она была чтобы дальше
# обект перезачитался
token.processToken._po = None]]>
                </event>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: po[&apos;dep_id&apos;],   &apos;id&apos;: po[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="3783f171-7cac-4545-bb78-24c861412394" name="Переход к Обработка заявки" target_id="43bee16f-8b7e-4b60-ac5d-a3be9d22ea0e"/>
        </condition>
        <condition id="2f53b989-dbf0-4a72-9300-20faf1801f2f" name="Продолжить" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;accept&apos;"/>
        <condition id="2b151181-dba6-4742-ada6-b256f149ce05" name="Отказать" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;decline&apos;">
            <timer id="8ec8302d-2b43-411d-a418-cb9e97e1d044" name="Регистрация во внешних системах при отказе" description="Регистрация во внешних системах при отказе {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
            <call id="24ab4ed1-8f86-4ffd-bbc8-124c36098d8f" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT"/>
            <split id="ecaf9136-4334-4ba0-99a1-e7ee89180e5e" name="Результат регистрации">
                <condition id="e64348e7-d616-4490-a927-62b58933fb72" name="Успешно"/>
                <condition id="4ded36d0-e674-424c-be2c-24b3030ed4fb" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
                    <task id="d29e4467-3201-49c9-91e0-d9fb82911c82" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                        <journal time="leave">
                            <![CDATA[{{task.description}}]]>
                        </journal>
                        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                            <p name="objectKey" expression="{  &apos;dep_id&apos;: po[&apos;dep_id&apos;],   &apos;id&apos;: po[&apos;id&apos;] }"/>
                            <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                            <p name="readOnly" expression="False"/>
                            <p name="object" expression="&apos;app&apos;"/>
                            <p name="form" expression="&apos;appEditTask&apos;"/>
                        </clientTask>
                    </task>
                    <jump id="50f6b923-fc89-42c5-867d-f6481626a387" name="Переход к Регистрация во внешних системах при отказе" target_id="8ec8302d-2b43-411d-a418-cb9e97e1d044"/>
                </condition>
            </split>
            <script id="f893b0cc-7feb-4a23-ad38-2d657e2e86a1" name="Установка отказа по контролю обеспечения">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать',
    'declineReason': '08',
    'show_dialog': False,
}
]]>
            </script>
            <jump id="6c0dd460-ade8-4118-b562-8cf4d00a2dd2" name="Переход к Обработка решения по заявке" target_id="38700b77-13f5-4deb-b969-0a59263c98fd"/>
        </condition>
    </split>
    <call id="c13d9e45-c208-46d1-8f58-61bcee0a22c6" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT"/>
    <split id="9d58cf82-a943-44d7-a8b9-d899d0c82bf0" name="Статус регистрации заявки">
        <condition id="1e6f595d-c2f4-4d84-b55c-a7d6640a7ec7" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="cb3556b8-f7e2-4626-a75e-7b8eab12e3e0" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: po[&apos;dep_id&apos;],   &apos;id&apos;: po[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="6578a303-3bcd-4bcb-b18d-57818bbff1be" name="Переход к Обработка заявки" target_id="43bee16f-8b7e-4b60-ac5d-a3be9d22ea0e"/>
        </condition>
        <condition id="3b0c00b1-810f-4f74-9d56-6530d09813f7" name="Успешно"/>
    </split>
    <split id="8b001f42-847a-47d3-9a1d-682d475926cf" name="Требуется анализ в АФС">
        <condition id="27b37e48-b942-4529-a18e-e08a0287d851" name="Да" expression="po[&apos;app&apos;].get(&apos;newObjectType&apos;) != &apos;1&apos;">
            <call id="9a816266-2401-4e8a-aa5c-987e11883527" name="Анализ заявки в АФС" call="&apos;AFS_ANALYZE&apos;" result_from="afs_status" result_to="afs_status"/>
            <timer id="48ca8eca-a2ff-4613-a540-37d3bf627483" name="Результат обработки в АФС" description="Результат обработки в АФС, заявка {{po.app.code}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
            <split id="188d9474-ce52-4583-bcd0-70f65f7c9735" name="Результат обработки в АФС">
                <condition id="21d4de54-0f54-4b7b-bdcb-8837bebe8774" name="Отказ банка" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;decline&apos;)">
                    <script id="abcb24f3-1576-4c16-bfcc-0510754843f6" name="Установка отказа по АФС">
                        <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '02',
    'number': '1',
    'date': decision_date,
    'text': 'Отказ по стоп факторам',
    'declineReason': '04',
    'show_dialog': False,
}

]]>
                    </script>
                    <jump id="72ad1053-80d7-487f-b1b9-586c7a0b5860" name="Переход к Обработка решения по заявке" target_id="38700b77-13f5-4deb-b969-0a59263c98fd"/>
                </condition>
                <condition id="154cc45a-8124-4fa6-b786-3a871fcb67a1" name="Пройдены" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;accept&apos;)"/>
                <condition id="4f8c3634-588d-4495-9366-fbaa22ab00d3" name="Не пройдены, но пропускаем" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;ignore&apos;)">
                    <script id="5b45c7da-f297-4855-ae87-f4dd5ba0af0e" name="Обработка исключения">
                        <journal time="leave">
                            <![CDATA[Допускается нарушение методики]]>
                        </journal>
                    </script>
                </condition>
            </split>
        </condition>
        <condition id="538745df-fcfa-46a3-a795-2c83bd8cf2b4" name="Нет"/>
    </split>
    <call id="5855d1ea-2e6b-44c5-9ab9-12e2f4792739" name="Получение заключений" call="&apos;APP_CONCLUSIONS_V2&apos;" result_from="conclusions_result" result_to="conclusions_status"/>
    <split id="738430b8-e70f-4a14-9403-323e592302b6" name="Заключения получены">
        <condition id="6e925fcd-8e3d-49d4-841e-34ce4b921783" name="Отказать" expression="pv[&apos;conclusions_status&apos;][&apos;status&apos;] == &apos;decline&apos;">
            <script id="8cd75164-b07f-4263-b91a-be9e30f8166c" name="Установка результата по заявке">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '02',
    'number': '1',
    'date': decision_date,
    'text': pv['conclusions_result']['text'],
    'declineReason': '04',
    'show_dialog': False,
}


            ]]>
            </script>
            <jump id="e07c387c-91cb-43ea-8f5a-ef035c1f8c3f" name="Переход к Обработка решения по заявке" target_id="38700b77-13f5-4deb-b969-0a59263c98fd"/>
        </condition>
        <condition id="5ca339ad-0051-4ca4-8158-359a82c42991" name="Продолжить" expression="pv[&apos;conclusions_status&apos;][&apos;status&apos;] == &apos;continue&apos;"/>
        <condition id="99f1149a-043f-4185-910f-1a4c3fbe6cbe" name="В доработку" expression="pv[&apos;conclusions_status&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="e6d2f51a-a8c9-4dcf-a018-4d88a04c8a7f" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[Доработка заявки {{po.app.code}}, {{po.client.name}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: po[&apos;dep_id&apos;],  &apos;id&apos;: po[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="5fb45eb7-3c14-4950-826c-87dbbf1203c6" name="Переход к Обработка заявки" target_id="43bee16f-8b7e-4b60-ac5d-a3be9d22ea0e"/>
        </condition>
    </split>
    <call id="c5b38106-6763-46c9-97ab-bb8fdfa7edf1" name="Принятие решения" call="pv[&apos;decisionWorkflow&apos;] if pv.get(&apos;decisionWorkflow&apos;) else &apos;APP_DECISION&apos;" result_from="decision" result_to="decision"/>
    <split id="e5702d1b-e149-4e98-85a1-1ee1a9066789" name="Решения получены">
        <condition id="3669a309-78c2-4586-a380-2f32f648482c" name="Продолжить"/>
        <condition id="578cfd30-ac94-4e8a-8cad-92112d7ce92b" name="В доработку" expression="pv[&apos;decision&apos;][&apos;decision&apos;] in (&apos;review&apos;, &apos;rework&apos;)">
            <task id="649d0b88-d693-46d9-b5b9-f80c32fd5c2e" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <clientTask path="/aoa/ObjectTaks" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: po[&apos;dep_id&apos;],  &apos;id&apos;: po[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="a08a24cf-d3d7-469f-90e8-d5879dd7245d" name="Переход к Обработка заявки" target_id="43bee16f-8b7e-4b60-ac5d-a3be9d22ea0e"/>
        </condition>
    </split>
    <call id="38700b77-13f5-4deb-b969-0a59263c98fd" name="Обработка решения по заявке" call="&apos;APP_REVIEW_FIN&apos;">
        <p name="decision" expression="pv.get(&apos;decision&apos;)"/>
        <p name="show_dialog" expression="pv.get(&apos;DECISION_SHOW_DIALOG&apos;)"/>
    </call>
    <script id="9e237dd2-e0cc-4b31-ae4b-2f7807a7ce4c" name="Стадия рассмотрения: завершено">
        <journal time="leave">
            <![CDATA[Рассмотрение заявки завершено {{po.app.code}}, {{po.client.name}} ]]>
        </journal>
        <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from loanapp.services.application import setState

with AuthenticatedUser() as au:
    setState({
        'dep_id': po['dep_id'],
        'id': po['id'],
        'stage': 'COMPLETED',
    })

]]>
    </script>
</workflow>