<workflow id="APP_REVIEW_AUTO_V2" name="Рассмотрение заявки. автоматическое v2">
    <event name="onGetProcessObject">
        <![CDATA[ok = pv.get('objectKey')
if not ok:
    raise Exception('Не задан ключ объекта для запуска сценария, objectKey');
    
kv = ok.split(':')
pk = kv[1].split(',')
appkey = { 
    'dep_id' : int(pk[0]),
    'id' : int(pk[1])
}

#
# Загружаем общую информацию по заявке
#
from colvir_cbs.auth import AuthenticatedUser
from loanapp.services.application import getApplication
with AuthenticatedUser():
    token._po = getApplication(appkey)]]>
    </event>
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <script id="133046f1-c3ce-49cc-8c1f-7eda948eb618" name="Инициализация">
        <journal time="leave">
            <![CDATA[Начало обработки заявки {{po.app.code}}, {{po.client.name}}]]>
        </journal>
        <![CDATA[
ok = pv.get('objectKey')

kv = ok.split(':')
pk = kv[1].split(',')
pv['dep_id'] = int(pk[0])
pv['id'] = int(pk[1])

#
# Проверяем и устанавливаем инициатора заявки
#
if token.process.initiator != po['user']['code']:
    #
    # Процесс запустил не пользователь, который создал заявку, поменяем
    #
    user = po['user']['code']
    token.process.initiator = user
    token.process.save()

    from apng_core.easyflow.auth import Authentication
    from apng_core.auth import ColvirUser
    Authentication.setAuthenticatedUser(ColvirUser(username=user))


pv['asoki_requests'] = []


]]>
    </script>
    <script id="a338df76-8f29-46c4-8c5d-e8961a01bb93" name="Проверка возможности запуска">
        <![CDATA[#
# Наличие запущенных процессов
#
from apng_core.easyflow.models import Token
from apng_core.easyflow.services import RuntimeService as rs

filter = {
    'objectKey': pv['objectKey'],
    'parent': None,
    'flow_id': po['app']['reviewWorkflow'],
    'state__in': ['active', 'suspended']
}

processes = Token.objects.filter(**filter).exclude(id=token.process.id)
if len(processes) > 0:
    raise UserException({
        'message': 'Заявка {appNo} уже отправлена на рассмотрении'.format(
            appNo = po['app']['code']
        )
    }) from None

]]>
    </script>
    <script id="d59130df-ec3a-4372-9c2a-0a9db0433536" name="Состояние заявки: на рассмотрении">
        <![CDATA[from apng_core.aoa.services import execObjectMethod
execObjectMethod({
    'object': 'app', 'method': 'setState',
    'params': {
        'dep_id': pv['dep_id'],
        'id': pv['id'],
        'state': 'ON_REVIEW',
        'stage': 'START',
    }
})

]]>
    </script>
    <timer id="746a8df4-6eb1-4055-ab53-66207329a49a" name="Обработка заявки" description="Обработка заявки {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:05:00" action="continue"/>
    <script id="fbf06d31-1c5a-4093-962b-f376d69ba02e" name="Информирование клиента о начале рассмотрения заявки">
        <journal time="leave">
            <![CDATA[Информирование клиента, SMS: {{po.client.phone}}]]>
        </journal>
    </script>
    <timer id="155f7436-e697-4914-b51d-e1691da7a823" name="Обработка заявки" description="Обработка заявки {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:05:00" action="continue"/>
    <call id="ff3ad1a4-6414-4371-a05e-8bd74481c1d5" name="Контроль ввода заявки" call="&apos;APP_CHECK_INPUT&apos;" result_from="result" result_to="app_check_result">
        <p name="objectKey" expression="pv.get(&apos;objectKey&apos;)"/>
    </call>
    <split id="dddd8b84-165f-4351-94e0-cb2fefd4c2cc" name="Результат контроля ввода заявки">
        <condition id="228603e3-963e-4ffc-b7c2-ce2c2b183f87" name="В доработку" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="c40317f8-e43e-4d4f-864d-27a11ae79a0a" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],   &apos;id&apos;: pv[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="4de9f96d-fb3b-4826-80ca-b790f54d1dca" name="Переход к Обработка заявки" target_id="155f7436-e697-4914-b51d-e1691da7a823"/>
        </condition>
        <condition id="3bc95dab-4ce1-4b12-b971-f52eca530710" name="Продолжить" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;accept&apos;"/>
        <condition id="f3d38d4d-8389-446b-b73c-ebd042503926" name="Отказать" expression="pv[&apos;app_check_result&apos;][&apos;status&apos;] == &apos;decline&apos;">
            <timer id="2ed13b93-3300-4381-878a-696ce9445536" name="Регистрация во внешних системах" description="Регистрация во внешних системах, заявка {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:05:00" action="continue"/>
            <split id="59411edb-54b3-4c95-813e-1e186e55bd45" name="Проверять занятость">
                <condition id="36dea771-102f-4ea4-8551-c314ec9ad694" name="Да" expression="po.get(&apos;income&apos;) is not None">
                    <call id="c1a3af5c-a327-4782-8fed-655938f38249" name="Проверка занятости клиента" call="&apos;APP_CHECK_INCOME_ALL&apos;" result_from="result" result_to="income_result">
                        <p name="objectKey" expression="pv[&apos;objectKey&apos;]"/>
                    </call>
                </condition>
                <condition id="7c8c9d38-a9f9-418e-8b0c-4ac816661f22" name="Нет"/>
            </split>
            <call id="2292d393-f998-4fc2-9459-45d8e1f7fa3d" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT">
                <p name="objectKey" expression="pv[&apos;objectKey&apos;]"/>
            </call>
            <split id="2a348c35-2fb9-4d42-ae4f-34ef067e60dd" name="Результат регистрации">
                <condition id="56cda356-f92b-4a9e-8d5b-1cf3c4b57313" name="Успешно"/>
                <condition id="ee6104c5-fc92-4fcb-939b-007a8b5ea51e" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
                    <task id="3c7dd42d-90ec-42e6-8b44-d4a635278aed" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                        <journal time="leave">
                            <![CDATA[{{task.description}}]]>
                        </journal>
                        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                            <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],   &apos;id&apos;: pv[&apos;id&apos;] }"/>
                            <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                            <p name="readOnly" expression="False"/>
                            <p name="object" expression="&apos;app&apos;"/>
                            <p name="form" expression="&apos;appEditTask&apos;"/>
                        </clientTask>
                    </task>
                    <jump id="6bad7bd0-5dee-4ed8-93b8-233498778d44" name="Переход к Регистрация заявки во внешних системах" target_id="2292d393-f998-4fc2-9459-45d8e1f7fa3d"/>
                </condition>
            </split>
            <script id="1e71e889-cfa4-465f-b18b-2c9e64e4df5f" name="Установка отказа по контролю обеспечения">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать',
    'declineReason': '08',
    'show_dialog': False,
}
]]>
            </script>
            <jump id="aa07ba62-7cb5-4863-b63b-2c4bf9ae3e82" name="Переход к Обработка решения по заявке" target_id="fde095ba-f361-488d-b8f8-00a11f736fff"/>
        </condition>
    </split>
    <timer id="ea54ba88-60c3-4cda-98e3-ef20629a5edc" name="Регистрация во внешних системах" description="Регистрация во внешних системах {{po.CODE}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:05:00" action="continue"/>
    <call id="249a61dd-4ba1-4c88-8ef5-1f214a3716f4" name="Регистрация заявки во внешних системах" call="&apos;APP_REGISTER_EXT&apos;" result_from="REGISTER_RESULT" result_to="REGISTER_RESULT"/>
    <split id="c8645780-eab7-4d41-963b-9e59843e7e70" name="Статус регистрации заявки">
        <condition id="a224a03a-41d9-4561-8239-ef1e29a7e478" name="В доработку" expression="pv[&apos;REGISTER_RESULT&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="5880fe79-e562-4178-b933-20ac6bc912ab" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],  &apos;id&apos;: pv[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="28cae2e9-d2e2-4da6-833c-871ae35a9968" name="Переход к Регистрация заявки во внешних системах" target_id="249a61dd-4ba1-4c88-8ef5-1f214a3716f4"/>
        </condition>
        <condition id="74dbaab2-1fde-4787-8a16-e6110a986365" name="Успешно"/>
    </split>
    <call id="bf8e70e6-7e39-4402-a2ba-24100311bef1" name="Проверка занятости клиента" call="&apos;APP_CHECK_INCOME_ALL&apos;" result_from="result" result_to="income_result"/>
    <split id="766cc9fa-ca8a-4dc3-832c-678925d5c2e8" name="Занятость подтверждена">
        <condition id="0d0c7e7e-0ae2-4b0e-92a1-e6c3518875c9" name="Да" expression="pv[&apos;income_result&apos;][&apos;status&apos;] == &apos;accept&apos;"/>
        <condition id="cb5c626c-4fc7-49c4-ad7c-034a8d86ec36" name="В доработку" expression="pv[&apos;income_result&apos;][&apos;status&apos;] == &apos;review&apos;">
            <task id="363eee30-c5fd-457b-b46c-12e2911448a2" name="Коррекция заявки" autoStart="true" description="Коррекция заявки. Заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[{{task.description}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{  &apos;dep_id&apos;: pv[&apos;dep_id&apos;],   &apos;id&apos;: pv[&apos;id&apos;] }"/>
                    <p name="actions" expression="[   {&apos;name&apos;: &apos;Продолжить&apos;, &apos;value&apos;: &apos;continue&apos;},  ]"/>
                    <p name="readOnly" expression="False"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appEditTask&apos;"/>
                </clientTask>
            </task>
            <jump id="af6d649e-3c85-4203-a266-5651e4bb32aa" name="Переход к Обработка заявки" target_id="155f7436-e697-4914-b51d-e1691da7a823"/>
        </condition>
        <condition id="03fe1f66-c1ad-4ced-b458-29c2966d7bb5" name="Отказать" expression="pv[&apos;income_result&apos;][&apos;status&apos;] == &apos;decline&apos;">
            <script id="445c02c3-3771-4175-a351-f7cbdb60dfdc" name="Установка отказа по контролю занятости">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday


pv['decision'] = {
    'decision': 'decline',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Отказать. Занятость заемщика/созаёмщика/поручителя не подтверждена',                 
    'declineReason': '08',
    'show_dialog': False,
}
]]>
            </script>
            <jump id="d3f751b0-6c0b-4f3f-9598-97e5c979ae6a" name="Переход к Обработка решения по заявке" target_id="fde095ba-f361-488d-b8f8-00a11f736fff"/>
        </condition>
    </split>
    <call id="5f3c2a58-ad38-4ec6-99a9-61c70ea24ed9" name="Анализ заявки в АФС" call="&apos;AFS_ANALYZE&apos;" result_from="afs_status" result_to="afs_status"/>
    <timer id="72a4d275-2923-48fe-8645-b37d5cf8b524" name="Результат обработки в АФС" description="Результат обработки в АФС, заявка {{po.app.code}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
    <split id="6d194f40-b3a0-487d-a21a-79849d5bb0b3" name="Результат обработки в АФС">
        <condition id="a65c5418-991c-4e30-81c8-94986a047822" name="Отказ банка" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;decline&apos;)">
            <script id="47fb43c1-d987-4a16-a34a-b13d89d0e456" name="Установка отказа по АФС">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '02',
    'number': '1',
    'date': decision_date,
    'text': 'Отказ по стоп факторам',
    'declineReason': '04',
    'show_dialog': False,
}

]]>
            </script>
            <jump id="c0466aff-913b-44c5-9d98-a0298440feef" name="Переход к Обработка решения по заявке" target_id="fde095ba-f361-488d-b8f8-00a11f736fff"/>
        </condition>
        <condition id="d90919c2-1302-46ed-b16b-5c5e016ad6d6" name="Успешно" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;accept&apos;)"/>
        <condition id="86a41dd4-70d1-4d9d-8ee5-872d7a02e4a2" name="Отказ, но пропускаем" expression="pv[&apos;afs_status&apos;][&apos;status&apos;] in (&apos;ignore&apos;)">
            <script id="4f62baa5-50ad-4c64-93bb-54d1938a8f6e" name="Обработка исключения">
                <journal time="leave">
                    <![CDATA[Допускается нарушение методики]]>
                </journal>
            </script>
        </condition>
    </split>
    <script id="9dd7d671-4b16-47d2-993d-f392d75b6bfc" name="Установка положительного решения">
        <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'accept',
    'code': '01',
    'number': '1',
    'date': decision_date,
    'text': 'Разрешить',
    'declineReason': '',
    'show_dialog': False,
}

#
# Для заявок через мобильное приложение номер решения присвается автоматическ
# Подтверждение исполнителя не требуется
#
#if process_vars['req']['app'].get('inputChannel') == 'mobile':
#    process_vars['decision']['show_dialog'] = False

   ]]>
    </script>
    <call id="fde095ba-f361-488d-b8f8-00a11f736fff" name="Обработка решения по заявке" call="&apos;APP_REVIEW_FIN&apos;">
        <p name="decision" expression="pv.get(&apos;decision&apos;)"/>
    </call>
    <script id="c9a75848-3435-48f5-bc36-a6fc5313a1c3" name="Стадия рассмотрения">
        <![CDATA[from apng_core.aoa.services import execObjectMethod
from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    execObjectMethod({
        'object': 'app', 'method': 'setState',
        'params': {
            'dep_id': pv['dep_id'],
            'id': pv['id'],
            'stage': 'COMPLETED',
        }
    })

]]>
    </script>
</workflow>