<workflow id="APP_CHECK_DOSSIER" name="Проверка документов досье">
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <event name="onGetProcessObject">
        <![CDATA[ok = pv.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')

from apng_core.aoa.services import execObjectMethod
token._po = execObjectMethod({
    'object': 'app', 'method': 'getApplication',
    'params': {
        'dep_id': int(pk[0]),
        'id'    : int(pk[1]),
    }
})
]]>
    </event>
    <script id="e5b533b6-aceb-4ad1-a126-bc9f0dab1ff6" name="Инициализация">
        <![CDATA[ok = process_vars.get('objectKey')


# Из объекта получаем идентификаторы заявки    
kv = ok.split(':')
pk = kv[1].split(',')
po['dep_id'] = int(pk[0])
po['id'] = int(pk[1])
]]>
    </script>
    <timer id="08417d51-bb76-409d-b2ae-5db1307e677e" name="Проверка досье" description="Проверка досье, заявка {{po.app.code}}, {{po.client.name}}" duration="00:00:00" errorDuration="00:01:00" action="continue"/>
    <script id="d4650649-7db3-4e95-8d80-e3e0fa850d49" name="Проверка обязательных документов">
        <![CDATA[#
# Документы при зявке
#
app_docs = execObjectMethod({
    'object': 'app', 'method': 'getDossier',
    'params': {
        'dep_id': po['dep_id'],
        'id': po['id'],
    }
})

#
# Обязательные документы по продукту
#
product_setofdocs = list(filter(
    lambda x: x['isRequired'],
    execObjectMethod({
        'object': 'bank_dossier', 'method': 'getSetOfDocuments',
        'params': {
            'productCode': po['app']['productCode'],
            'appOnly': True,
        }
    })
))

product_docs = []
for s in product_setofdocs:
    docs = execObjectMethod({
        'object': 'bank_dossier', 'method': 'getDocumentsInSet',
        'params': {'setId': s['setId']}
    })
    product_docs.extend(docs)

missing_docs = []

def findDoc(docs, code):
    d = list(filter(lambda x: x['docType']==code and x['isPresent'], docs))
    return len(d) > 0

for pd in product_docs:
    if not findDoc(app_docs, pd['code']):
        missing_docs.append(pd)
        
pv['missing_docs'] = missing_docs

#
# Костыль для запрета проверки досье. По хорошему нужно совсем отключить вызов контроля в этом случае
#
if po['product']['options'].get('disableDossierCheck'):
    pv['missing_docs'] = []

]]>
    </script>
    <split id="1fb64ee7-9789-41c1-8d35-d4ba62d02c47" name="Результат проверки">
        <condition id="c47fbae7-e2ad-4854-8875-26ae4c9861f3" name="Пройдена" expression="len(process_vars[&apos;missing_docs&apos;]) == 0">
            <script id="2d98a6c1-c9c0-4ba0-b0b5-36f3b7389475" name="Установка результата">
                <journal time="leave">
                    <![CDATA[Обязательность документов досье проверена]]>
                </journal>
                <![CDATA[process_vars['result'] = {
    'status': 'accept'
}]]>
            </script>
        </condition>
        <condition id="fd581ad5-e9a7-4984-8eb2-c0537785c10e" name="Не пройдена" expression="len(process_vars[&apos;missing_docs&apos;]) &gt; 0">
            <script id="7ddfba64-5d18-4ad3-8c70-eeb8d5cac321" name="Подготовка сообщения">
                <journal time="leave">
                    <![CDATA[Не предоставлены обязательные документы досье]]>
                </journal>
                <![CDATA[messages = [
    'Не предоставлены следующие документы досье'
]
messages.extend(
    ['  - ' + x['name'] for x in process_vars['missing_docs']]
)
process_vars['last_error'] = {
    'message' : '\n'.join(messages)
}]]>
            </script>
            <task id="47fb873e-cf64-4389-9b3c-87451449b889" name="Не заполнено досье" autoStart="true" description="Не заполнено досье, заявка {{po.app.code}}, {{po.client.name}}">
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="pv.get(&apos;objectKey&apos;)"/>
                    <p name="message" expression="pv[&apos;last_error&apos;][&apos;message&apos;]"/>
                    <p name="actionVar" expression="&apos;action&apos;"/>
                    <p name="actions" expression="[  { &apos;name&apos;: &apos;В доработку&apos;, &apos;value&apos;: &apos;review&apos; } , { &apos;name&apos;: &apos;Отказать&apos;, &apos;value&apos;: &apos;decline&apos; }  ]"/>
                    <p name="object" expression="&apos;easyflow&apos;"/>
                    <p name="form" expression="&apos;processDialogTask&apos;"/>
                </clientTask>
            </task>
            <script id="25185f2c-5322-458e-81f3-7ec16cf264d7" name="Установка результата">
                <journal time="leave">
                    <![CDATA[Контроль обязательности досье: {% if process_vars.action == 'decline' %}Отказать{% elif process_vars.action == 'review' %}В доработку{% endif %}]]>
                </journal>
                <![CDATA[pv['result'] = {
    'status': pv['action']
}]]>
            </script>
        </condition>
    </split>
</workflow>