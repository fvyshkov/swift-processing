<workflow id="APP_CLIENT_CONFIRMATION" name="Подтверждение клиентом получения кредита">
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <event name="onGetProcessObject">
        <![CDATA[if not pv.get('objectKey'):
    raise Exception('Не задан ключ объекта для запуска сценария, objectKey');
    
kv = pv['objectKey'].split(':')
pk = kv[1].split(',')


token._po = execObjectMethod({
    'object': 'app', 'method': 'getApplication',
    'params': {
        'dep_id': int(pk[0]),
        'id'    : int(pk[1]),
    }
})
]]>
    </event>
    <script id="8676800a-51e7-4470-8dd1-9446c60f6b43" name="Инициализация">
        <![CDATA[ok = pv.get('objectKey')

kv = ok.split(':')
pk = kv[1].split(',')
process_vars['dep_id'] = int(pk[0])
process_vars['id'] = int(pk[1])


from apng_core.aoa.services import execObjectMethod
appSettings = execObjectMethod({'object': 'settings', 'method': 'get'})['loanapp']
def getParameter(s, name):
    return next(filter(lambda x: x['code']==name, s.get('parameters', [])), {}).get('value', None)

pv['waitClientAcceptFiz'] = getParameter(appSettings, 'waitClientAcceptFiz')
if pv['waitClientAcceptFiz']:
    import datetime
    pv['waitClientAcceptFiz'] = token.created + datetime.timedelta(days=pv['waitClientAcceptFiz'])
]]>
    </script>
    <task id="0120d231-1c5a-4c56-8d98-876b623a32ce" name="Контакт с клиентом" autoStart="true" description="Подтверждение клиента, заявка {{po.app.code}}, {{po.client.name}}">
        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
            <p name="caption" expression="task[&apos;description&apos;]"/>
            <p name="actions" expression="[{ &apos;name&apos;: &apos;Клиент согласен&apos;, &apos;value&apos;: &apos;accept&apos; }, {&apos;name&apos;: &apos;Клиент отказался&apos;, &apos;value&apos;: &apos;reject&apos;}]"/>
            <p name="actionVar" expression="&apos;clientDecision&apos;"/>
            <p name="objectKey" expression="{&apos;dep_id&apos;: pv[&apos;dep_id&apos;], &apos;id&apos;: pv[&apos;id&apos;]}"/>
            <p name="object" expression="&apos;app&apos;"/>
            <p name="form" expression="&apos;appResolutionTask&apos;"/>
        </clientTask>
        <timer id="9804a856-2e62-49b5-a462-f83820753474" name="Ожидание подтверждения клиентом" description="Ожидание подтверждения клиентом, заявка {{po.app.code}}" duration="pv[&apos;waitClientAcceptFiz&apos;]" action="terminate" condition="not (po[&apos;client&apos;][&apos;isJur&apos;] or po[&apos;client&apos;][&apos;isIE&apos;]) and pv.get(&apos;waitClientAcceptFiz&apos;) is not None" errorDuration="00:01:00">
            <script id="717d922f-8049-4da3-93af-898ddfc7226c" name="Завершение ожидания">
                <journal time="enter">
                    <![CDATA[Истекло время ожидания подтверждения клиента]]>
                </journal>
                <![CDATA[clientTask = token.parent.parent

clientTask.signal('complete', {
    'clientDecision': {
        'value': 'decline'
    }
})

]]>
            </script>
        </timer>
    </task>
    <script id="772842e9-2867-48e6-90e9-839305c6bfc1" name="Сохранение в досье">
        <![CDATA[if pv.get('dossier'):
    from colvir_cbs.auth import AuthenticatedUser
    from apng_core.aoa.services import execObjectMethod
    with AuthenticatedUser():
        execObjectMethod({
            'object': 'app', 'method': 'saveDossierFiles',
            'params': {
                'dep_id': pv['dep_id'],
                'id': pv['id'],
                'files': pv['dossier']
            }
        })

]]>
    </script>
    <split id="67b1f081-7a69-4324-92b5-9d9e75bbffc8" name="Проверять фотографию клиента">
        <condition id="5e157228-bb2d-4f1b-bccb-ebf039cf33b7" name="Да" expression="pv.get(&apos;checkClientPhoto&apos;, False) and pv[&apos;clientDecision&apos;][&apos;value&apos;] == &apos;accept&apos;">
            <script id="84467461-e6e6-4928-9443-e77a9b4b59e0" name="Контроль фотографии клиента">
                <![CDATA[
from apng_core.aoa.services import execObjectMethod

# Ищем фото клиента в атрибутах процесса, передаётся из задачи
check_photo = next(filter(lambda x: x['docType']=='CRED.FOTO_CLI', pv.get('dossier', [])),None)

if not check_photo:
    # Ищем в досье заявки
    check_photo = execObjectMethod({
        'object': 'loanapp',
        'method': 'getDossierFileByType',
        'params': {
            'dep_id': pv['dep_id'],
            'id': pv['id'],
            'docType': 'CRED.FOTO_CLI'
        }
    })

if not check_photo:
    raise UserException('В подтверждение клиента не передана фотография')

execObjectMethod({
    'object': 'loanapp',
    'method': 'compareClientPhoto',
    'params': {
        'appKey': {
            'dep_id': pv['dep_id'],
            'id': pv['id'],
        },
        'client': po['client'],
        'check_photo': check_photo
    }
})

]]>
            </script>
            <timer id="49c8f79c-337e-41f6-8de6-ceac7a3b7700" name="Фотография проверена" description="" duration="00:00:01" errorDuration="00:01:00" action="continue"/>
        </condition>
        <condition id="305a778f-1cda-4773-958b-87383a4a10e4" name="Нет" expression="not pv.get(&apos;checkClientPhoto&apos;, False) or pv[&apos;clientDecision&apos;][&apos;value&apos;] != &apos;accept&apos;"/>
    </split>
    <script id="2ce36dea-2401-4a2b-96a1-95e6820a8c71" name="Установка результата">
        <journal time="leave">
            <![CDATA[{% if pv.DECISION.status == 'accept' %}
Клиент согласен на получение кредита
{% else %}
Клиент отказался от получения кредита
{% endif %}]]>
        </journal>
        <![CDATA[#raise Exception(process_vars['clientDecision'])

pv['DECISION'] = {
    'status': pv['clientDecision']['value'],
}

]]>
    </script>
</workflow>