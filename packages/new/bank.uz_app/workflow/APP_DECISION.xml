<workflow id="APP_DECISION" name="Принятие решения по завявке">
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)

]]>
    </event>
    <event name="onGetProcessObject">
        <![CDATA[ok = process_vars.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')

token._po = execObjectMethod({
    'object': 'app', 'method': 'getApplication',
    'params': {
        'dep_id': int(pk[0]),
        'id'    : int(pk[1]),
    }
})

]]>
    </event>
    <script id="b853679f-2f1b-44ba-b060-cbf02313c220" name="Инициализация">
        <![CDATA[ok = pv.get('objectKey')

kv = ok.split(':')
pk = kv[1].split(',')
pv['dep_id'] = int(pk[0])
pv['id'] = int(pk[1])


# Начальные настройки места рассмотрения
pv['decisions'] = {
    'auto'          : False,
    'underwriter'   : False,
    'head'          : True,
    'directors'     : True,
    'sharers'       : True,
    
}

pv['decisions']['underwriter'] = execObjectMethod({
    'object': 'cbs.dectbl', 'method': 'evalByOrd',
    'params': {
        'idDep': pv['dep_id'],
        'idOrd': pv['id'],
        'tblName': 'L_LIM_UNDERWRITER',
        'required': False,
    }
}) == '1'
pv['decisions']['head'] = execObjectMethod({
    'object': 'cbs.dectbl', 'method': 'evalByOrd',
    'params': {
        'idDep': pv['dep_id'],
        'idOrd': pv['id'],
        'tblName': 'L_LIM_HEAD',
        'required': False,
    }
}) == '1'
pv['decisions']['directors'] = execObjectMethod({
    'object': 'cbs.dectbl', 'method': 'evalByOrd',
    'params': {
        'idDep': pv['dep_id'],
        'idOrd': pv['id'],
        'tblName': 'L_LIM_DIRECTORS',
        'required': False,
    }
}) == '1'
pv['decisions']['sharers'] = execObjectMethod({
    'object': 'cbs.dectbl', 'method': 'evalByOrd',
    'params': {
        'idDep': pv['dep_id'],
        'idOrd': pv['id'],
        'tblName': 'L_LIM_SHARERS',
        'required': False,
    }
}) == '1'


from apng_core.auth import User
with User(initDbSession={'application': 'bank'}) as u:
    decision_date = u.user.operday

# Решение филиала по умолчанию
process_vars['decision_filial'] = {
    'decision': '',
    'code': '02',
    'number': '',
    'date': decision_date,
    'text': '',
    'declineReason': ''
}

# Решение головного по умолчанию
process_vars['decision_head'] = {
    'decision': '',
    'code': '03',
    'number': '',
    'date': decision_date,
    'text': '',
    'declineReason': ''
}

# Решение правление по умолчанию
process_vars['decision_directors'] = {
    'decision': '',
    'code': '04',
    'number': '',
    'date': decision_date,
    'text': '',
    'declineReason': ''
}


# Решение совета акционеров (совет банка) по умолчанию
process_vars['decision_sharers'] = {
    'decision': '',
    'code': '05',
    'number': '',
    'date': decision_date,
    'text': '',
    'declineReason': ''
}

]]>
    </script>
    <script id="83ba5780-1e0c-44c0-8870-98a5410b9ee8" name="Стадия рассмотрения">
        <![CDATA[execObjectMethod({
    'object': 'app', 'method': 'setState',
    'params': {
        'dep_id': pv['dep_id'],
        'id': pv['id'],
        'stage': 'DECISIONS',
    }
})

]]>
    </script>
    <split id="51647ec9-e508-4f56-b287-3a86d3ffc2a9" name="Автоматическое решение">
        <condition id="ced56b89-416f-41ef-8a8c-0dbf4a57aca4" name="Да" expression="process_vars[&apos;decisions&apos;][&apos;auto&apos;] == True">
            <script id="b5f57268-f810-4650-9fe7-27427dedd753" name="Установка решения"/>
            <terminate id="45d902e6-8503-40d4-9b8e-71ffd16e04cd" name="Завершение"/>
        </condition>
        <condition id="a0609ad5-9eb2-4c4e-9c2d-71304561a85b" name="Нет" expression="process_vars[&apos;decisions&apos;][&apos;auto&apos;] == False"/>
    </split>
    <split id="6740f678-30d9-4ffb-b380-547838380652" name="Требуется решение Андеррайтера">
        <condition id="61a70f77-09e9-4333-ba1a-d070abae8681" name="Да" expression="process_vars[&apos;decisions&apos;][&apos;underwriter&apos;] == True">
            <task id="979c6587-229a-401e-882e-74ebc62791a9" name="Регистрация решение андеррайтера" autoStart="true" description="Решение андеррайтера по заявке: {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[Решение андреррайтера: {{process_vars.resolution_underwriter.name}}, {{process_vars.resolution_underwriter.text}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{&apos;dep_id&apos;: pv[&apos;dep_id&apos;], &apos;id&apos;: pv[&apos;id&apos;]}"/>
                    <p name="actions" expression="[{ &apos;name&apos;: &apos;Одобрить&apos;, &apos;value&apos;: &apos;accept&apos; }, {&apos;name&apos;: &apos;Отказать&apos;, &apos;value&apos;: &apos;decline&apos;} , {&apos;name&apos;: &apos;В доработку&apos;, &apos;value&apos;: &apos;review&apos;}  ]"/>
                    <p name="actionVar" expression="&apos;resolution_underwriter&apos;"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appResolutionTask&apos;"/>
                </clientTask>
            </task>
            <split id="c6df0d16-a1e5-4d07-b30f-9bac7d563491" name="Решение андеррайтера">
                <condition id="71f32544-8c29-4115-87a5-a45a1709641f" name="Одобрить" expression="process_vars[&apos;resolution_underwriter&apos;][&apos;value&apos;] == &apos;accept&apos;">
                    <script id="61b77070-7ad0-49cb-8b2b-37e8bb15ae1b" name="Установка решения">
                        <![CDATA[from apng_core.auth import User
with User(initDbSession={'application': 'bank'}) as u:
    decision_date = u.user.operday
    
txt = pv['resolution_underwriter'].get('text')        
pv['decision'] = {
    'decision': process_vars['resolution_underwriter']['value'],
    'code': '01',
    'number': '',
    'date': decision_date,
    'text': txt if txt else 'Одобрить',
    'declineReason': '',
    'show_dialog': True,
}                    ]]>
                    </script>
                </condition>
                <condition id="2d570350-e4e5-4443-a295-e9a866a920de" name="Отказать" expression="process_vars[&apos;resolution_underwriter&apos;][&apos;value&apos;] == &apos;decline&apos;">
                    <script id="7e2d9a7b-ef66-473b-9f50-ef97fafeef9d" name="Установка решения">
                        <![CDATA[from apng_core.auth import User
with User(initDbSession={'application': 'bank'}) as u:
    decision_date = u.user.operday
    
txt = pv['resolution_underwriter'].get('text')        
pv['decision'] = {
    'decision': process_vars['resolution_underwriter']['value'],
    'code': '01',
    'number': '',
    'date': decision_date,
    'text': txt if txt else 'Отказать',
    'declineReason': '',
    'show_dialog': True,
}                    ]]>
                    </script>
                </condition>
                <condition id="ed2c4da0-978f-4181-bcc0-03b5fc324567" name="В доработку" expression="process_vars[&apos;resolution_underwriter&apos;][&apos;value&apos;] == &apos;review&apos;">
                    <script id="4863854e-eb3f-4511-9053-a1e46df584ee" name="Установка решения">
                        <![CDATA[from apng_core.auth import User
with User(initDbSession={'application': 'bank'}) as u:
    decision_date = u.user.operday

txt = pv['resolution_underwriter'].get('text')        
pv['decision'] = {
    'decision': pv['resolution_underwriter']['value'],
    'code': '01',
    'number': '',
    'date': decision_date,
    'text': txt if txt else 'В доработку',
    'declineReason': '',
    'show_dialog': True,
}                    ]]>
                    </script>
                </condition>
            </split>
            <terminate id="2e637e3e-07f1-4a58-8470-832a1b2d3db1" name="Завершение"/>
        </condition>
        <condition id="51a650ca-1de1-4dc6-bf39-4043d48f7b91" name="Нет" expression="process_vars[&apos;decisions&apos;][&apos;underwriter&apos;] == False"/>
    </split>
    <task id="8b8d86f3-1f2d-4eaa-a6ab-4746b578df77" name="Регистрация решения КК филиала" autoStart="true" description="Регистрация решения КК филиала, заявка {{po.app.code}}, {{po.client.name}}">
        <journal time="leave">
            <![CDATA[{% load wfj %}Решение КК филиала: {{pv.decision.name}}, {{pv.decision.number}} от {{pv.decision.date|date}} {{pv.decision.text}}]]>
        </journal>
        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
            <p name="objectKey" expression="{ &apos;dep_id&apos;: process_vars[&apos;dep_id&apos;], &apos;id&apos;: process_vars[&apos;id&apos;]}"/>
            <p name="decision" expression="process_vars.get(&apos;decision_filial&apos;)"/>
            <p name="actionVar" expression="&apos;decision&apos;"/>
            <p name="object" expression="&apos;app&apos;"/>
            <p name="form" expression="&apos;appDecisionTask&apos;"/>
        </clientTask>
    </task>
    <split id="1540c423-2af7-4605-8b57-1bd84cd71999" name="Решение КК филиала">
        <condition id="1625b5bb-b6a8-4b36-83d9-b563c51425a9" name="Одобрить" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;accept&apos;"/>
        <condition id="e8443c8b-0bf6-4e90-aca6-6f0dce2f1b65" name="Отказать" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;decline&apos;">
            <script id="8ec5dcc5-035c-40e3-8179-4e35a74e7be3" name="Установка решения">
                <![CDATA[process_vars['decision']['show_dialog'] = False]]>
            </script>
            <terminate id="274da55a-45a7-494a-85de-0c4747bcbbb6" name="Завершение"/>
        </condition>
        <condition id="ca406304-e612-46ba-9f9c-7887b57c7f30" name="В доработку" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;review&apos;">
            <terminate id="4a0240fc-6990-4554-8f2a-3ea506aeca6f" name="Завершение"/>
        </condition>
    </split>
    <split id="adaef0d3-f1b5-4772-ba35-b64ec04ca0f1" name="Требуется решение КК головного банка">
        <condition id="1a700fe3-f3bf-4747-9015-ffcdb231c4e9" name="Да" expression="process_vars[&apos;decisions&apos;][&apos;head&apos;] == True">
            <task id="3cfff8b6-a50f-4d99-8162-ea9d004ad786" name="Регистрация решения КК головного банка" autoStart="true" description="Регистрация рещения КК головного банка, заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[Решение КК головного банка: {% if pv.decision.decision == 'accept' %}Одобрить{% else %}Отказать{%endif%}, {{pv.decision.text}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{ &apos;dep_id&apos;: process_vars[&apos;dep_id&apos;], &apos;id&apos;: process_vars[&apos;id&apos;]}"/>
                    <p name="decision" expression="process_vars.get(&apos;decision_head&apos;)"/>
                    <p name="actionVar" expression="&apos;decision&apos;"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appDecisionTask&apos;"/>
                </clientTask>
            </task>
            <split id="2e0c5058-c008-45c8-8743-7f223540b4a5" name="Решение КК головного банка">
                <condition id="51f67594-3b0a-444f-9f3e-3519531b620a" name="Одобрить" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;accept&apos;"/>
                <condition id="f94efc89-c644-400c-bea6-2d4894afeb79" name="Отказать" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;decline&apos;">
                    <script id="33e9d606-5a31-4772-82f0-f3f609ac1c33" name="Устаноака решения">
                        <![CDATA[process_vars['decision']['show_dialog'] = False]]>
                    </script>
                    <terminate id="cb25e238-6d2f-4535-a86d-5d7f98bf80a4" name="Завершение"/>
                </condition>
                <condition id="ee0b5f9f-24f7-4506-a8d6-094b097f2147" name="В доработку" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;review&apos;">
                    <terminate id="c54df066-095c-43e5-af60-843784fe8a1f" name="Завершение"/>
                </condition>
            </split>
        </condition>
        <condition id="398fefb2-eb34-4a68-b907-bba99d52e9b7" name="Нет" expression="process_vars[&apos;decisions&apos;][&apos;head&apos;] == False"/>
    </split>
    <split id="a32b6f50-3283-40de-9764-2749ca001530" name="Требуется решение правления">
        <condition id="cbab7298-2456-42da-a4dd-d85a47fa6087" name="Да" expression="process_vars[&apos;decisions&apos;][&apos;directors&apos;] == True">
            <task id="f6a707af-e1fa-4415-8f9f-3a01e066564e" name="Регистрация решения правления" autoStart="true" description="Регистрация решения правления, заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[Решение правления: {% if pv.decision.decision == 'accept' %}Одобрить{% else %}Отказать{%endif%}, {{pv.decision.text}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{ &apos;dep_id&apos;: process_vars[&apos;dep_id&apos;], &apos;id&apos;: process_vars[&apos;id&apos;]}"/>
                    <p name="decision" expression="process_vars.get(&apos;decision_directors&apos;)"/>
                    <p name="actionVar" expression="&apos;decision&apos;"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appDecisionTask&apos;"/>
                </clientTask>
            </task>
            <split id="faae11c3-8194-4a25-bf86-22a80500fe62" name="Решение правления">
                <condition id="d7fd8a4d-c5e7-40b4-9373-91b81b10ad89" name="Одобрить" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;accept&apos;"/>
                <condition id="2cdfc1f4-b2d6-4ad9-892e-a2b78b43e05e" name="Отказать" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;decline&apos;">
                    <script id="e664f5de-742e-4332-91cd-b2d0544aebc1" name="Установка решения">
                        <![CDATA[process_vars['decision']['show_dialog'] = False]]>
                    </script>
                    <terminate id="87ffdfff-655d-45de-813c-fa933f18b07b" name="Завершение"/>
                </condition>
                <condition id="55499fcf-256d-4318-9542-3c56a208705d" name="В доработку" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;review&apos;">
                    <terminate id="20ae8c3a-237f-48fb-ba37-3882a03a8c60" name="Завершение"/>
                </condition>
            </split>
        </condition>
        <condition id="f63cee45-fa8b-4a7d-9d4a-36fbd493fff9" name="Нет" expression="process_vars[&apos;decisions&apos;][&apos;directors&apos;] == False"/>
    </split>
    <split id="15d46510-d53a-4814-bce0-bce2ca05fd8e" name="Требуется решение Совета банка">
        <condition id="5d13a420-1f32-4db9-94b3-009505ec8bb2" name="Да" expression="process_vars[&apos;decisions&apos;][&apos;sharers&apos;] == True">
            <task id="4cb97231-f1a7-4ad1-86e8-4d2af0d96887" name="Регистрация решения Совета Банка" autoStart="true" description="Регистрация решения Совета Банка, заявка {{po.app.code}}, {{po.client.name}}">
                <journal time="leave">
                    <![CDATA[Решение Совета банка: {% if pv.decision.decision == 'accept' %}Одобрить{% else %}Отказать{%endif%}, {{pv.decision.text}}]]>
                </journal>
                <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                    <p name="objectKey" expression="{ &apos;dep_id&apos;: process_vars[&apos;dep_id&apos;], &apos;id&apos;: process_vars[&apos;id&apos;]}"/>
                    <p name="decision" expression="process_vars.get(&apos;decision_sharers&apos;)"/>
                    <p name="actionVar" expression="&apos;decision&apos;"/>
                    <p name="object" expression="&apos;app&apos;"/>
                    <p name="form" expression="&apos;appDecisionTask&apos;"/>
                </clientTask>
            </task>
            <split id="13620d82-43c8-48d4-838e-ff8853ce45d4" name="Решение Совета банка">
                <condition id="dbddf1fd-53fa-4bbd-b4ae-9efda4cb6058" name="Одобрить" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;accept&apos;"/>
                <condition id="f5c95884-61b2-45a1-8186-52564b45241b" name="Отказать" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;decline&apos;">
                    <script id="f9057d84-054d-46ee-a537-70b4b2592158" name="Установка решения">
                        <![CDATA[process_vars['decision']['show_dialog'] = False]]>
                    </script>
                    <terminate id="80c51ad8-06a2-464d-b266-3353ab55d368" name="Завершение"/>
                </condition>
                <condition id="61aa633e-eb4a-4ab6-b8d8-b8e25edb71c0" name="В доработку" expression="process_vars[&apos;decision&apos;][&apos;decision&apos;] == &apos;review&apos;">
                    <terminate id="34f2fb77-3d58-4ee0-9a94-6b1d5cc38abe" name="Завершение"/>
                </condition>
            </split>
        </condition>
        <condition id="1879a33a-eab4-4e98-a40e-dc370260516c" name="Нет" expression="process_vars[&apos;decisions&apos;][&apos;sharers&apos;] == False">
            <split id="adada30d-f530-4183-8753-c6ddd0d5bc89" name="Связанное лицо">
                <condition id="6b4b7af6-da6c-4cdd-aa00-3cbb7cda6c8e" name="Да" expression="po[&apos;client&apos;].get(&apos;isRelatedPerson&apos;, False) == True">
                    <script id="65e4f271-ca03-47ef-adae-be9e4e0b1c9e" name="Подготовка положительного решения СБ">
                        <![CDATA[process_vars['decision_sharers']['decision'] = 'accept']]>
                    </script>
                    <task id="63ddcfb7-199a-4878-bab0-e800da9e05c6" name="Регистрация решения Совета Банка по связанным лицам" autoStart="true" description="Регистрация решения Совета Банка по связанным лицам, заявка {{po.app.code}}, {{po.client.name}}">
                        <journal time="leave">
                            <![CDATA[{%load wfj%}
Решение Совета Банка по связанным лицам: {% if pv.decision_related.decision == 'accept' %}Одобрить{% else %}Отказать{%endif%}, {{pv.decision_related.date | date}} {{pv.decision_related.number}} {{pv.decision_related.text}}]]>
                        </journal>
                        <clientTask path="/aoa/ObjectTask" taskName="{{task.description}}">
                            <p name="objectKey" expression="{ &apos;dep_id&apos;: pv[&apos;dep_id&apos;], &apos;id&apos;: pv[&apos;id&apos;]}"/>
                            <p name="decision" expression="pv.get(&apos;decision_sharers&apos;)"/>
                            <p name="actionVar" expression="&apos;decision_related&apos;"/>
                            <p name="disableReview" expression="True"/>
                            <p name="object" expression="&apos;app&apos;"/>
                            <p name="form" expression="&apos;appDecisionTask&apos;"/>
                        </clientTask>
                    </task>
                </condition>
                <condition id="11254df8-4ebc-452b-b5aa-7913860c94b0" name="Нет"/>
            </split>
        </condition>
    </split>
    <script id="81d79d0b-7e2a-49a5-a7f8-2e731ee085be" name="Установка решения">
        <![CDATA[process_vars['decision']['show_dialog'] =  False]]>
    </script>
</workflow>