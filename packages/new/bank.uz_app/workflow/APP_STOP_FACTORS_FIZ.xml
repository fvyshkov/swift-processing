<workflow id="APP_STOP_FACTORS_FIZ" name="Расчет стоп факторов физлиц">
    <event name="onGetProcessObject">
        <![CDATA[ok = pv.get('objectKey')
if not ok:
    raise Exception('Не задан ключ объекта для запуска сценария, objectKey');
    
kv = ok.split(':')
pk = kv[1].split(',')


#
# Загружаем общую информацию по заявке
#
from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    from apng_core.aoa.services import execObjectMethod
    token._po = execObjectMethod({
        'object': 'app', 'method': 'getApplication',
        'params': {
            'dep_id': int(pk[0]),
            'id'    : int(pk[1]),
        }
    })
]]>
    </event>
    <event name="onCandidates">
        <![CDATA[def depIn(dep):
    from colvir_cbs.services import bank
    return po['app']['depCode'] in bank.getDepartmentsCodes(dep)
]]>
    </event>
    <script id="7b2c2f9d-3c91-48a1-976a-81c44b7faf86" name="Инициализация">
        <![CDATA[ok = process_vars.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')
pv['dep_id'] = int(pk[0])
pv['id'] = int(pk[1])

from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():

    pv['decisions'] = {}
    
    # Настройка пропуска стоп факторов 1
    pv['decisions']['skipSF1'] = execObjectMethod({
        'object': 'cbs.dectbl', 'method': 'evalByOrd',
        'params': {
            'idDep': pv['dep_id'],
            'idOrd': pv['id'],
            'tblName': 'L_LIM_SKIP_SF1',
            'required': False,
        }
    }) == '1'

    # Настройка пропуска стоп факторов 2
    pv['decisions']['skipSF2'] = execObjectMethod({
        'object': 'cbs.dectbl', 'method': 'evalByOrd',
        'params': {
            'idDep': pv['dep_id'],
            'idOrd': pv['id'],
            'tblName': 'L_LIM_SKIP_SF2',
            'required': False,
        }
    }) == '1'

    # Настройка пропуска стоп факторов 3
    pv['decisions']['skipSF3'] = execObjectMethod({
        'object': 'cbs.dectbl', 'method': 'evalByOrd',
        'params': {
            'idDep': pv['dep_id'],
            'idOrd': pv['id'],
            'tblName': 'L_LIM_SKIP_SF3',
            'required': False,
        }
    }) == '1'

]]>
    </script>
    <call id="0aa71e28-6851-424e-8a4f-101c2041d987" name="Расчет стоп факторов 1" call="&apos;APP_STOP_FACTORS_1&apos;" result_from="SF1_status" result_to="SF1_status">
        <p name="req" expression="pv.get(&apos;req&apos;)"/>
    </call>
    <split id="277b37cc-7e0d-4d92-932f-2eb46c3af5f5" name="Обработка стоп факторов 1">
        <condition id="cd585e08-7ae1-4152-b1ee-96ba053587bd" name="Отказ СФ1" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;decline&apos; and po[&apos;app&apos;].get(&apos;skipSF1&apos;, False) == False and pv[&apos;decisions&apos;][&apos;skipSF1&apos;] == False">
            <script id="e1c5f540-bee5-4b8b-bcaf-d0453067f913" name="Установка отказа">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '02',
    'number': '',
    'date': decision_date,
    'text': 'Отказ по стоп факторам 1',
    'declinReason': '',
    'show_dialog': True,
}

]]>
            </script>
            <terminate id="7a5e4631-c6fb-4e29-bb21-bf159ec1843d" name="Завершение"/>
        </condition>
        <condition id="2b64ea2b-4f18-406c-911f-69ea31a27af1" name="Отказ СФ1, но пропускаем" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;decline&apos; and (po[&apos;app&apos;].get(&apos;skipSF1&apos;, False) == True or pv[&apos;decisions&apos;][&apos;skipSF1&apos;] == True)" comment="Пропуск по таблице решений либо по служебному атрибуту в заявке">
            <script id="9d9e9899-21ee-4d8a-8977-6b4fbaca2b01" name="Журнализация исключения">
                <journal time="leave">
                    <![CDATA[Допускается нарушение стоп факторов 1]]>
                </journal>
            </script>
        </condition>
        <condition id="e1f7355c-6dc1-41df-8c2a-4912a67fe150" name="Пройдены СФ1" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;accept&apos;"/>
        <condition id="1a202900-2059-4c82-ac5c-e195258438f4" name="В доработку" expression="pv[&apos;SF1_status&apos;][&apos;status&apos;] == &apos;review&apos; ">
            <script id="6dee7fa7-c2dd-4fc6-ab2d-9bc83212c5c6" name="Установка результата">
                <![CDATA[process_vars['decision'] = {
    'decision': 'REVIEW',
}

]]>
            </script>
            <terminate id="f1045a3c-4a09-45fe-aae9-5a1f2f56934d" name="Завершение"/>
        </condition>
    </split>
    <call id="9c5b5543-756b-4a2c-94c0-2474ad8a2290" name="Расчет стоп факторов 2" call="&apos;APP_STOP_FACTORS_2&apos;" result_from="SF2_status" result_to="SF2_status">
        <p name="objectKey" expression="pv.get(&apos;objectKey&apos;)"/>
        <p name="req" expression="pv.get(&apos;req&apos;)"/>
        <p name="canReview" expression="True"/>
    </call>
    <split id="d6274b89-a2f5-49a8-a5be-24e799452057" name="Обработка стоп факторов 2">
        <condition id="d5895439-62ac-4e06-a037-9ddc3a4f257f" name="Отказ СФ2" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] == &apos;decline&apos; and po[&apos;app&apos;].get(&apos;skipSF2&apos;, False) == False and pv[&apos;decisions&apos;][&apos;skipSF2&apos;] == False">
            <script id="5fc02c1d-61c9-4f07-98d4-c2804deb01f6" name="Установка отказа СФ2">
                <![CDATA[
from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'decline',
    'code': '02',
    'number': '',
    'date': decision_date,
    'text': 'Отказ по стоп факторам 2',
    'declineReason': '',
    'show_dialog': True,
}

]]>
            </script>
            <terminate id="39cec6b7-c2c5-433a-8710-361e43ae32f2" name="Завершение"/>
        </condition>
        <condition id="52cc310e-4a40-4a65-b328-232ba280e034" name="Пересмотр после изменений" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] == &apos;review&apos; and po[&apos;app&apos;].get(&apos;skipSF2&apos;, False) == False and pv[&apos;decisions&apos;][&apos;skipSF2&apos;] == False">
            <script id="3707fd1d-8fe4-44f9-bbc2-bcc801a5096c" name="Установка статуса на пересмотр">
                <![CDATA[from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

pv['decision'] = {
    'decision': 'review',
    'date': decision_date,
    'text': 'СФ2. Пересмотр после изменений',
}]]>
            </script>
            <terminate id="4e18ef45-d8e3-4846-a13e-8883cdc6344d" name="Завершение"/>
        </condition>
        <condition id="5620316a-be4a-4a05-9aa2-36fd0c17fa73" name="Отказ СФ2, но пропускаем" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] == &apos;decline&apos; and (po[&apos;app&apos;].get(&apos;skipSF2&apos;, False) == True or  pv[&apos;decisions&apos;][&apos;skipSF2&apos;] == True)">
            <script id="3595610d-9773-4d2e-a149-5c1b07b86212" name="Журнализация исключения">
                <journal time="leave">
                    <![CDATA[Допускается нарушение стоп факторов 2]]>
                </journal>
            </script>
        </condition>
        <condition id="cfb04d24-5ef7-46f9-8cd2-dd28213c1183" name="Пройдены СФ2" expression="pv[&apos;SF2_status&apos;][&apos;status&apos;] in (&apos;accept&apos;, &apos;altAmountScoring&apos;)"/>
    </split>
    <split id="b191607c-c60c-45b0-958e-7711fbe2c614" name="Требуется расчет СФ3">
        <condition id="fb9bb099-5dba-4d8e-9808-d1e928b1a556" name="Да" expression="&apos;SF3&apos; in po[&apos;afs&apos;][&apos;sheets&apos;] if po[&apos;afs&apos;].get(&apos;sheets&apos;) else True">
            <call id="15cbb488-e653-45cd-bbfd-9df58ade1cdc" name="Расчет стоп факторов 3" call="&apos;APP_STOP_FACTORS_3&apos;" result_from="SF3_status" result_to="SF3_status">
                <p name="req" expression="pv.get(&apos;req&apos;)"/>
                <p name="canReview" expression="True"/>
            </call>
            <split id="b2099668-e8c9-4689-bf1d-e5629c74ab1a" name="Обработка стоп факторов 3">
                <condition id="c1a96d95-d94b-420b-93bc-ad408b3dac8b" name="Отказ СФ3" expression="pv[&apos;SF3_status&apos;][&apos;status&apos;] == &apos;declineClient&apos; or pv[&apos;SF3_status&apos;][&apos;status&apos;] == &apos;decline&apos; and po[&apos;app&apos;].get(&apos;skipSF3&apos;, False) == False and pv[&apos;decisions&apos;][&apos;skipSF3&apos;] == False">
                    <script id="2af79e56-8046-442b-936c-72a0b4b322a5" name="Установка отказа СФ3">
                        <![CDATA[
from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

if pv['SF3_status']['status'] == 'decline':
    pv['decision'] = {
        'decision': 'decline',
        'code': '02',
        'number': '',
        'date': decision_date,
        'text': 'Отказ по стоп факторам 3',
        'declineReason': '',
        'show_dialog': True,
    }

elif pv['SF3_status']['status'] == 'declineClient':
    pv['decision'] = {
        'decision': 'decline',
        'code': '02',
        'number': '',
        'date': decision_date,
        'text': 'Отказ по стоп факторам 3',
        'declineReason': '08',
        'show_dialog': True,
    }
    ]]>
                    </script>
                    <terminate id="368af7b6-5beb-41c1-b1ea-5adb4620f77a" name="Завершение"/>
                </condition>
                <condition id="815af90f-07a8-4fb8-849c-1c4df99720c2" name="Пересмотр после изменений" expression="pv[&apos;SF3_status&apos;][&apos;status&apos;] == &apos;review&apos; and po[&apos;app&apos;].get(&apos;skipSF3&apos;, False) == False and pv[&apos;decisions&apos;][&apos;skipSF3&apos;] == False">
                    <script id="5f0ab8cd-5334-4cb9-87c5-56cf647c9c06" name="Установка пересмотря после изменений">
                        <![CDATA[
from apng_core.easyflow.auth import Authentication
from colvir_cbs.auth import AuthenticatedUser

with AuthenticatedUser(user=Authentication.getAuthenticatedUser().code) as au:
    decision_date = au.operday

process_vars['decision'] = {
    'decision': 'review',
    'date': decision_date,
    'text': 'СФ3. Пересмотр после изменений',
}]]>
                    </script>
                    <terminate id="9d16c250-882f-4cc1-8512-399f31d30fb4" name="Завершение"/>
                </condition>
                <condition id="14f600aa-b36c-4984-a17e-3f489829c03a" name="Отказ, но пропускаем" expression="pv[&apos;SF3_status&apos;][&apos;status&apos;] in (&apos;decline&apos;) and (po[&apos;app&apos;].get(&apos;skipSF3&apos;, False) == True or pv[&apos;decisions&apos;][&apos;skipSF3&apos;] == True)">
                    <script id="731abe66-1dc1-4d0a-a2f6-a63942bc0d96" name="Журнализация исключения">
                        <journal time="leave">
                            <![CDATA[Допускается нарушение стоп факторов 3]]>
                        </journal>
                    </script>
                </condition>
                <condition id="435d652f-6ea5-4cef-8521-5c9a4e094caf" name="Пройдены СФ3" expression="pv[&apos;SF3_status&apos;][&apos;status&apos;] in (&apos;accept&apos;, &apos;altAmount&apos;, &apos;altAmountScoring&apos;, &apos;ignore&apos;)"/>
            </split>
        </condition>
        <condition id="7cec2954-7cf4-4a78-8107-104fa856f67f" name="Нет"/>
    </split>
    <script id="5a347daa-920c-448b-8fe3-181efcab67c2" name="Установка результата">
        <![CDATA[
from apng_core.easyflow.auth import Authentication

pv['decision'] = {
    'decision': 'accept',
    'code': '02',
    'number': '',
    'date': Authentication.getAuthenticatedUser().operday,
    'text': 'Стоп факторы пройдены',
    'declineReason': '',
    'show_dialog': True,
}

]]>
    </script>
</workflow>