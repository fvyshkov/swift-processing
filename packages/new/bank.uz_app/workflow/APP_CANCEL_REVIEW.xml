<workflow id="APP_CANCEL_REVIEW" name="Отмена рассмотрения заявки">
    <event name="onGetProcessObject">
        <![CDATA[ok = pv.get('objectKey')
kv = ok.split(':')
pk = kv[1].split(',')

from colvir_cbs.auth import AuthenticatedUser
with AuthenticatedUser():
    from apng_core.aoa.services import execObjectMethod
    token._po = execObjectMethod({
        'object': 'app', 'method': 'getApplication',
        'params': {
            'dep_id': int(pk[0]),
            'id'    : int(pk[1]),
        }
    })
]]>
    </event>
    <script id="8ab751f3-dcdc-4c6c-b62f-1d358344190a" name="Инициализация">
        <![CDATA[from colvir_cbs.auth import AuthenticatedUser

ok = process_vars.get('objectKey')

kv = ok.split(':')
pk = kv[1].split(',')
pv['dep_id'] = int(pk[0])
pv['id'] = int(pk[1])


if not po['app'].get('reviewWorkflow'):
    raise Exception('Не определен сценарий рассмотрения заявки')]]>
    </script>
    <script id="5b981b20-df28-48b1-a4c7-95047e5c8c3e" name="Завершение процессов рассмотрения">
        <journal time="leave">
            <![CDATA[Рассмотрение заявки прервано]]>
        </journal>
        <![CDATA[from apng_core.easyflow.models import Token
from apng_core.easyflow.services import RuntimeService as rs

filter = {
    'objectKey': pv['objectKey'],
    'parent': None,
    'flow_id': po['app']['reviewWorkflow'],
}

processes = Token.objects.filter(**filter)

for p in processes:
    rs.stopToken(p.id)



]]>
    </script>
    <script id="fa0a0a97-d7ad-4f51-8ba6-ea1ace917961" name="Установка состояния заявки: Рассмотрение отменено">
        <journal time="leave">
            <![CDATA[Процесс рассмотрения отменен]]>
        </journal>
        <![CDATA[from apng_core.aoa.services import execObjectMethod

execObjectMethod({
    'object': 'app', 'method': 'setState',
    'params': {
        'dep_id': pv['dep_id'],
        'id': pv['id'],
        'state': 'CANCELED',
        'stage': 'CANCELED'
    }
})
]]>
    </script>
</workflow>