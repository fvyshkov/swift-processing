<workflow id="REQUEST_ModifyApplication" name="API. Изменение атрибутов заявки">
    <script id="8a9e4913-e933-4e34-a93c-064eb5c54d52" name="Проверка атрибутов запроса">
        <![CDATA[import sys
if not process_vars['request'].get('applicationId'):
    process_vars['error'] = {
        'error_text': 'applicationId required'
    }
    raise StopScriptExecution()
    
pk = process_vars['request']['applicationId'].split(';')
if len(pk) != 2:
    process_vars['error'] = {
        'error_text': 'Неправильный формат идентификатора завки'
    }
    raise StopScriptExecution()
    
process_vars['dep_id'] = pk[0]
process_vars['id'] = pk[1]

attributes = process_vars['request'].get('attributes')
if not attributes:
    process_vars['error'] = {
        'error_text': 'не перадн список атрибутов',
        'error_description': 'Передайте параметр attributes',
    }
    raise StopScriptExecution()
    
if attributes.get('amount') is not None:
    attributes['amount'] = float(attributes.get('amount'))
    
if 'interestRate' in attributes:
    attributes['interestRate'] = float(attributes['interestRate'])

process_vars['attributes'] = attributes



from colvir_cbs.auth import AuthenticatedUser
from apng_core.db import fetchall


with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        r = None
        
        if process_vars['attributes'].get('purposeCode'):
            p = {
                'purposeCode' : process_vars['attributes']['purposeCode'], 
            }
                
            cursor.execute("""
                SELECT 
                    *
                FROM L_PURDSC 
                WHERE CODE=:purposeCode
                """,
                p
            )
    
            data = fetchall(cursor)
            if len(data) != 1:
                process_vars['error'] = {
                    'error_text': 'Цель кредита не существует',
                    'error_description': 'Передайте правильную цель кредита, атрибут purposeCode',
                }
                raise StopScriptExecution()
         
        if 'loanTermCode' in attributes:
            p = {
                'loanTermCode' : attributes['loanTermCode'], 
            }
                
            cursor.execute("""
                SELECT 
                    T_PkgDeaPer.fID(:loanTermCode, 0) TERM_CODE
                FROM DUAL
                """,
                p
            )
    
            data = fetchall(cursor)
            if not (data[0]['TERM_CODE']):
                process_vars['error'] = {
                    'error_text': 'Неправильный срок договора',
                    'error_description': 'Убедитесь что срок договора %s существует в справочнике' % (attributes['loanTermCode']),
                }
                raise StopScriptExecution()
            ]]>
    </script>
    <split id="9a7f649b-4b9c-4fe4-9c6b-1a9d76db0d73" name="Контроль атрибутов пройден">
        <condition id="f53297a7-f5a0-40e7-98fb-f618a11d3515" name="Да" expression="process_vars.get(&apos;error&apos;) is None">
            <script id="558d8121-543c-4cf6-b2cf-71f9abe07401" name="Поиск заявки">
                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.db import fetchall
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        r = None
        
        params = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'], 
        }
            
        cursor.execute("""
            SELECT 
                r.REQ_SUM,
                T_pkgVal.fGetIsoCode(o.val_id) VAL_CODE,
                r.RATE_REQ,
                pur.CODE PUR_CODE,
                term.CODE TERM_CODE,
                nvl(l_Pkgreq_Django.fAttrAdd(r.dep_id, r.id,'VIDCRED'),
                    l_Pkgdeauniref.fGetClsRefValCode(d.ID, u_Pkguniref.fRefCode2Id('UZ_VIDCRED',0))
                ) VID_CRED,
                l_Pkgreq_Django.fAttrAdd(r.dep_id, r.id, 'ACTJUR') NORMATIVE_LEGAL_ACT,
                l_Pkgreq_Django.fAttrAdd(r.DEP_ID, r.ID ,'PNTGRACEOD') GRACE_DEBT
            FROM T_DEAPRD term, T_ORD o, L_PURDSC pur, T_DEA d, L_REQDEA r
            WHERE r.DEP_ID = :DEP_ID and r.ID = :ID
                and d.DEP_ID=r.DEP_ID and d.ID=r.ID
                and o.DEP_ID=d.DEP_ID and o.ID=d.ID
                and term.ID=r.REQ_PRD_ID
                and pur.ID(+) = r.PUR_ID
            """,
            params
        )

        data = fetchall(cursor)
        if len(data)!=1 :
            process_vars['error'] = {
                'error_text': 'Заявка не найдена'
            }
            raise StopScriptExecution()

        r = data[0]
        process_vars['attributes']['old_amount'] = float(r['REQ_SUM'])
        process_vars['attributes']['oldValCode'] = r['VAL_CODE']
        process_vars['attributes']['oldInterestRate'] = float(r['RATE_REQ'])
        process_vars['attributes']['oldLoanTermCode'] = r['TERM_CODE']
        process_vars['attributes']['oldPurposeCode'] = r['PUR_CODE']
        process_vars['attributes']['oldVidCred'] = r['VID_CRED']
        process_vars['attributes']['oldNormativeLegalAct'] = r['NORMATIVE_LEGAL_ACT']
        process_vars['attributes']['oldGraceDebt'] = r['GRACE_DEBT']



local_vars['objectKey'] = 'loanapp:%s,%s' % (process_vars['dep_id'], process_vars['id'])]]>
            </script>
            <split id="b1e76918-9152-4e7c-b229-75a74ed923da" name="Заявка найдена">
                <condition id="c3d6fc86-af55-484d-82fb-2dc58cfbe159" name="Да" expression="process_vars.get(&apos;error&apos;) is None">
                    <split id="44b414a8-62df-44b4-b86e-eae87566f9a1" name="Изменена сумма заявки">
                        <condition id="d5f87b3e-e0a5-455f-aa86-90d1b00ed289" name="Да" expression="process_vars[&apos;attributes&apos;].get(&apos;amount&apos;) is not None and process_vars[&apos;attributes&apos;].get(&apos;amount&apos;) != process_vars[&apos;attributes&apos;].get(&apos;old_amount&apos;)">
                            <script id="3c9eca71-1e14-4eb7-bc5e-a79dbd91734b" name="Изменение суммы заявки">
                                <journal time="leave">
                                    Изменена сумма заявки {{process_vars.attributes.old_amount}} на {{process_vars.attributes.amount}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'AMOUNT' : process_vars['attributes']['amount']
        }
            
        cursor.execute("""
            UPDATE L_REQDEA set
                REQ_SUM = :AMOUNT
            WHERE DEP_ID = :DEP_ID and ID = :ID
            """,
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="33c085da-ae4e-49fa-bd71-899dac0b99f3" name="Нет"/>
                    </split>
                    <split id="6714d1ef-4f8a-4141-a4e9-74b32ede9f4e" name="Валюта">
                        <condition id="f9bdc9b9-5169-49d7-8bf6-4c6887ddbb72" name="Да" expression="&apos;valCode&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;valCode&apos;] != process_vars[&apos;attributes&apos;][&apos;oldValCode&apos;]">
                            <script id="cd922361-307d-49b6-8a35-e12e5e7fbdbd" name="Изменение вылюты">
                                <journal time="leave">
                                    Изменена валюта с {{process_vars.attributes.oldValCode}} на {{process_vars.attributes.valCode}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'VAL_CODE' : process_vars['attributes']['valCode']
        }
            
        cursor.execute("""
            UPDATE T_ORD set
                VAL_ID = T_PkgVal.fValCode2Id(:VAL_CODE)
            WHERE DEP_ID = :DEP_ID and ID = :ID
            """,
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="9a11adfa-40bb-41d5-acb2-272afef0a516" name="Нет"/>
                    </split>
                    <split id="7ea686a1-606f-4abd-af37-c62969f65732" name="Процентная ставка">
                        <condition id="0a1d1c13-92ce-48c4-ad9a-c52229e38ad9" name="Да" expression="&apos;interestRate&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;interestRate&apos;] != process_vars[&apos;attributes&apos;][&apos;oldInterestRate&apos;]">
                            <script id="7170a8c7-7be7-418b-911a-3ac20de7f52f" name="Изменение процентной ставки">
                                <journal time="leave">
                                    Изменена процентная ставка с {{process_vars.attributes.oldInterestRate}} на {{process_vars.attributes.interestRate}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'INTEREST_RATE' : process_vars['attributes']['interestRate']
        }
            
        cursor.execute("""
            UPDATE L_REQDEA set
                RATE_REQ = :INTEREST_RATE
            WHERE DEP_ID = :DEP_ID and ID = :ID
            """,
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="9575e688-b310-463a-940e-d04da407522e" name="Условие 2"/>
                    </split>
                    <split id="48d2d77c-02dd-4c0d-8a3e-b5aff84aa617" name="Срок кредита">
                        <condition id="d57daaee-5c42-4bb4-b154-b90a9e1e9eee" name="Да" expression="&apos;loanTermCode&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;loanTermCode&apos;] != process_vars[&apos;attributes&apos;][&apos;oldLoanTermCode&apos;]">
                            <script id="f297459d-8b3e-4007-af27-1aa171e7a749" name="Изменение срока кредита">
                                <journal time="leave">
                                    Изменен срок кредита с {{process_vars.attributes.oldLoanTermCode}} на {{process_vars.attributes.loanTermCode}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'TERM_CODE' : process_vars['attributes']['loanTermCode']
        }
            
        cursor.execute("""
            UPDATE L_REQDEA set
                REQ_PRD_ID = T_PkgDeaPer.fID(:TERM_CODE)
            WHERE DEP_ID = :DEP_ID and ID = :ID
            """,
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="c9fd8941-0d8f-433a-afb3-e0b98add588d" name="Нет"/>
                    </split>
                    <split id="24673045-1efa-483d-8cdf-248baa5fe335" name="Изменение цели кредита">
                        <condition id="bf498d70-68b0-4790-86e7-38a95800cce1" name="Да" expression="&apos;purposeCode&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;].get(&apos;purposeCode&apos;) != process_vars[&apos;attributes&apos;].get(&apos;oldPurposeCode&apos;)">
                            <script id="d44235a2-2178-4cdd-b164-62626ebe099a" name="Изменение цели кредита">
                                <journal time="leave">
                                    Изменена цель кредита с {{process_vars.attributes.oldPurposeCode}} на {{process_vars.attributes.purposeCode}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'PUR_CODE' : process_vars['attributes']['purposeCode']
        }
            
        cursor.execute("""
            declare
                idPur number;
            begin
                select 
                    (select ID from L_PURDSC where CODE=:PUR_CODE)
                into idPur
                from dual;
                
                update L_REQDEA set
                    PUR_ID = idPur
                where DEP_ID=:DEP_ID and ID=:ID;
            end;
            /""",
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="2613be20-3575-4cde-a45b-cb63b95ad00c" name="Нет"/>
                    </split>
                    <split id="aa910af0-1a03-4416-8d1a-8d29fb5a2003" name="Вид кредитования">
                        <condition id="17c10ceb-cc70-4c6e-8487-717c3b8198eb" name="Да" expression="&apos;vidCred&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;vidCred&apos;] != process_vars[&apos;attributes&apos;][&apos;oldVidCred&apos;]">
                            <script id="e1bc13e9-192e-4d7e-8169-b0ed8f2048cc" name="Изменение вида кредитования">
                                <journal time="leave">
                                    Изменен вид кредитования с {{process_vars.attributes.oldVidCred}} на {{process_vars.attributes.vidCred}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'VID_CRED' : process_vars['attributes']['vidCred']
        }
            
        cursor.execute("""
            declare
            begin
                L_pkgReq_Django.pSaveAdd(:DEP_ID, :ID, 'VIDCRED', :VID_CRED);
            end;
            /""",
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="62641ac0-1a92-4407-80be-d936d31beec1" name="Нет"/>
                    </split>
                    <split id="5b51df06-afbd-4350-86a8-6c3ec0727532" name="Нормативно правовой акт">
                        <condition id="3fb8c206-f0f5-4857-8033-5c0d4492b035" name="Да" expression="&apos;normativeLegalAct&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;normativeLegalAct&apos;] != process_vars[&apos;attributes&apos;][&apos;oldNormativeLegalAct&apos;] ">
                            <script id="44394f91-459f-40ed-91bf-3a221a4e5d12" name="Изменение нормативно правового акта">
                                <journal time="leave">
                                    Изменен нормативно правовой акт с {{process_vars.attributes.oldNormativeLegalAct}} на {{process_vars.attributes.normativeLegalAct}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'NORMATIVE_LEGAL_ACT' : process_vars['attributes']['normativeLegalAct']
        }
            
        cursor.execute("""
            declare
            begin
                L_pkgReq_Django.pSaveAdd(:DEP_ID, :ID, 'ACTJUR', :NORMATIVE_LEGAL_ACT);
            end;
            /""",
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="ee143146-fc5c-4de9-98a4-e419aa513260" name="Нет"/>
                    </split>
                    <split id="1562f9de-1a49-4bf4-8ab8-f21ac06aad9c" name="Количество пунктов льготного периода ОД">
                        <condition id="1631ae7d-15a3-4892-8f04-ba970ffd2397" name="Да" expression="&apos;graceDebt&apos; in process_vars[&apos;attributes&apos;] and process_vars[&apos;attributes&apos;][&apos;graceDebt&apos;] != process_vars[&apos;attributes&apos;][&apos;oldGraceDebt&apos;]">
                            <script id="343dffd6-f69a-4ba8-bd3f-c0d78acb5647" name="Изменение льготного периода по ОД">
                                <journal time="leave">
                                    Изменено количество льготных периодов по ОД {{process_vars.attributes.oldGraceDebt}} на {{process_vars.attributes.graceDebt}}
                                </journal>
                                <![CDATA[from colvir_cbs.auth import AuthenticatedUser
from apng_core.easyflow.services import RunTimeService

import logging
logger = logging.getLogger('loanapp.api')

with AuthenticatedUser() as au:
    with au.getConnection().cursor() as cursor:
        p = {
            'DEP_ID' : process_vars['dep_id'], 
            'ID'     : process_vars['id'],
            'GRACE_DEBP' : process_vars['attributes']['graceDebt']
        }
            
        cursor.execute("""
            declare
            begin
                L_pkgReq_Django.pSaveAdd(:DEP_ID, :ID, 'PNTGRACEOD', :GRACE_DEBP);
            end;
            /""",
            p
        )]]>
                            </script>
                        </condition>
                        <condition id="e715c81f-3125-4840-9630-0ca5d052b952" name="Нет"/>
                    </split>
                </condition>
                <condition id="67a7b055-cb3f-493a-b6f9-29f82d09ce91" name="Нет">
                    <terminate id="e165cf63-32e5-4849-9376-d70652a342d4" name="Завершение"/>
                </condition>
            </split>
            <split id="b0d6e88e-ec56-41f5-9b88-8e725f47d0ec" name="Регистрировать изменения">
                <condition id="149b5043-c08e-4109-904d-14b9e2ea836b" name="Да" expression="process_vars[&apos;request&apos;].get(&apos;registerChange&apos;) == True">
                    <script id="5cf7a483-2e0b-4c93-860b-33aad2b2675b" name="Зпуск процесса регистрации заявки">
                        <![CDATA[from apng_core.easyflow.services import RuntimeService
import traceback

try:
    RuntimeService.startProcessByCode(
        'APP_REGISTER_EXT',
        {
            'objectKey': 'loanapp:%s,%s' % (process_vars['dep_id'], process_vars['id'])
        }
    )
except Exception as e:
    process_vars['error'] = {
        'error_text': 'Ошибка регистрации изменений заявки',
        'error_description': '',
        'error_trace': traceback.format_exc()
    }
]]>
                    </script>
                </condition>
                <condition id="440c3c61-3423-4a6d-b16e-9a29a2c6b076" name="Нет"/>
            </split>
        </condition>
        <condition id="36fe690e-8d2c-4c8b-8c38-a9cff1c90541" name="Нет">
            <terminate id="107513fa-f617-4b46-b418-7552ca0952bd" name="Завершение"/>
        </condition>
    </split>
    <script id="318da45e-f29b-4e1f-bf40-b326fd5a9ca2" name="Ответ">
        <![CDATA[process_vars['response'] = {
    'action': 'ok'
}]]>
    </script>
</workflow>