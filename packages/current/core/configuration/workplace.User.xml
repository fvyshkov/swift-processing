<?xml version="1.0" ?>
<model id="workplace.User" name="Пользователь">
	<task path="/aoa/ObjectTask">
		<p name="object" expression="'user'"/>
		<p name="form" expression="'editUserTask'"/>
		<p name="userCode" expression="objectId"/>
	</task>
	<description><![CDATA[description['code'] = obj.code
description['name'] = obj.name
description['file_name'] = '%s.%s' % (obj.code, 'xml')
description['file_path'] = 'users'
]]></description>
	<export><![CDATA[import json
exp = {
    'code': obj.code,
    'name': obj.name,
    'workplaces': []
}

uwl = obj.workplaces.all()
for uw in uwl:
    exp['workplaces'].append({
        'id': uw.workplace_id.__str__(),
        'name': uw.workplace.name,
    })

file['data'] = json.dumps(exp, indent=4, ensure_ascii=False)

]]></export>
	<import><![CDATA[from apng_core.workplace.models import User, UserWorkplace
import json

try:
    obj = User.objects.get(code=object_id)
except User.DoesNotExist:
    obj = User()
obj.code = object_id

imp = json.loads(file_data)

obj.name = imp['name']
obj._isImport = True
obj.save()

UserWorkplace.objects.filter(username=object_id).delete()
for w in imp.get('workplaces'):
    uw = UserWorkplace();
    uw.user = obj
    uw.username = object_id
    uw.workplace_id = w.get('id')
    uw.save()

]]></import>
	<lookup><![CDATA[lookup_field = 'code']]></lookup>
</model>
