{
    "forms": {
        "editUserTask": {
            "title": "Редактирование пользователя",
            "className": "vertical task task-panel",
            "style": {
                "height": "100%",
                "overflow": "hidden"
            },
            "$": {
                "@actions": {
                    "style": {
                        "margin": "16px 0px 16px 0px"
                    },
                    "$": {
                        ".ap": {
                            "control": "ActionPanel",
                            "controlOpts": {
                                "actions": [
                                    {
                                        "title": "Сохранить",
                                        "icon": "save",
                                        "mini": false,
                                        "action": {
                                            "name": "saveUser"
                                        },
                                        "disabled$": "!context.modified"
                                    }
                                ]
                            }
                        }
                    }
                },
                "@form": {
                    "style": {
                        "padding": "8px",
                        "overflow": "auto"
                    },
                    "form": "editUserForm"
                }
            },
            "actions": {
                "onTaskCreated": {
                    "js": "(task.params.userId || task.params.userCode) && backend.post('/aoa/execObjectMethod', {object: 'user', method: 'get', params: {id: task.params.userId, code: task.params.userCode}}).then((r)=>{mem.user=r; tm.setTaskTitle(task.key, `Пользователь ${r.code}`); forceUpdate()})"
                },
                "onModified": {
                    "js": "context.modified = true;"
                },
                "saveUser": {
                    "js": "backend.post('/aoa/execObjectMethod', {object: 'user', method: 'save', params: mem.user}).then(()=>{context.modified = false;})"
                }
            }
        },
        "editUserForm": {
            "title": "Форма редактирования пользователя",
            "className": "vertical",
            "$": {
                "user": {
                    "className": "vertical",
                    "$": {
                        "code": {
                            "label": "Код пользователя",
                            "style": {
                                "width": "200px"
                            },
                            "control": "TextEdit",
                            "actions": {
                                "onChange": {
                                    "name": "onModified"
                                }
                            }
                        },
                        "name": {
                            "label": "Наименование пользователя",
                            "style": {
                                "width": "450px"
                            },
                            "control": "TextEdit",
                            "actions": {
                                "onChange": {
                                    "name": "onModified"
                                }
                            }
                        },
                        "fixedPosition": {
                            "label": "Фиксированная позиция",
                            "style": {
                                "width": "200px"
                            },
                            "control": "TextEdit",
                            "actions": {
                                "onChange": {
                                    "name": "onModified"
                                }
                            }
                        },
                        "keepSession": {
                            "label": "Удерживать сессию",
                            "control": "Checkbox",
                            "actions": {
                                "onChange": {
                                    "name": "onModified"
                                }
                            }
                        },
                        "@workplaces": {
                            "title": "Рабочие места",
                            "className": "vertical",
                            "$": {
                                ".ap": {
                                    "control": "ActionPanel",
                                    "controlOpts": {
                                        "actions": [
                                            {
                                                "title": "Добавить",
                                                "icon": "add",
                                                "mini": true,
                                                "action": {
                                                    "js": "context.selectedWorkplace = null; frontend.dialog({object: 'workplace', form: 'selectWorkplaceDialog'});"
                                                }
                                            },
                                            {
                                                "title": "Удалить",
                                                "icon": "delete",
                                                "mini": true,
                                                "action": {
                                                    "name": "deleteWorkplace",
                                                    "confirm": {
                                                        "title": "Удаление",
                                                        "message$": "`Удалить рабочее место ${context.selectedWorkplace.code}?`",
                                                        "yes": "Да",
                                                        "no": "Нет"
                                                    }
                                                },
                                                "disabled$": "!context.selectedWorkplace"
                                            }
                                        ]
                                    },
                                    "actions": {
                                        "selectWorkplace": {
                                            "name": "addWorkplace"
                                        }
                                    }
                                },
                                "|workplaces": {
                                    "control": "ListTable",
                                    "controlOpts": {
                                        "rowDrag": true,
                                        "columns!": {
                                            "code": {
                                                "label": "Код",
                                                "width": 200
                                            },
                                            "name": {
                                                "label": "Наименование",
                                                "flex": 1
                                            }
                                        }
                                    },
                                    "actions": {
                                        "onChange": {
                                            "name": "onModified"
                                        }
                                    }
                                }
                            },
                            "actions": {
                                "onSelectionChanged": {
                                    "js": "context.selectedWorkplace = selectedRow;"
                                },
                                "addWorkplace": [
                                    {
                                        "js": "mem.workplaces = [...mem.workplaces, {id: params.workplace.id, code: params.workplace.code, name: params.workplace.name}]"
                                    },
                                    {
                                        "name": "onModified"
                                    }
                                ],
                                "deleteWorkplace": [
                                    {
                                        "js": "mem.workplaces.splice(mem.workplaces.indexOf(context.selectedWorkplace), 1); mem.workplaces = [...mem.workplaces];"
                                    },
                                    {
                                        "name": "onModified"
                                    }
                                ]
                            }
                        },
                        "settings": {
                            "className": "vertical",
                            "$": {
                                "@tasksPriles": {
                                    "title": "Профили мониторинга задач",
                                    "form": "taskProfilesForm"
                                }
                            }
                        }
                    }
                }
            }
        },
        "taskProfilesForm": {
            "title": "Профили мониторинга задач",
            "className": "vertical",
            "$": {
                ".ap": {
                    "control": "ActionPanel",
                    "controlOpts": {
                        "actions": [
                            {
                                "title": "Добавить",
                                "icon": "add",
                                "mini": true,
                                "action": {
                                    "js": "frontend.dialog({object: 'easyflow.taskmanage', form: 'selectProfileDialog'})"
                                }
                            },
                            {
                                "title": "Удалить",
                                "icon": "delete",
                                "mini": true,
                                "action": {
                                    "name": "deleteProfile",
                                    "confirm": {
                                        "title": "Удаление",
                                        "message$": "`Удалить профиль?`",
                                        "yes": "Да",
                                        "no": "Нет"
                                    }
                                },
                                "disabled$": "!context.selectedTaskProfile"
                            }
                        ]
                    },
                    "actions": {
                        "onProfileSelected": {
                            "name": "addProfile"
                        }
                    }
                },
                "|taskProfiles": {
                    "control": "ListTable",
                    "controlOpts": {
                        "columns!": {
                            "code": {
                                "label": "Код",
                                "width": 100,
                                "compact": true
                            },
                            "name": {
                                "label": "Наименование",
                                "flex": 1
                            }
                        }
                    }
                }
            },
            "actions": {
                "addProfile": [
                    {
                        "js": "mem.taskProfiles.push({code: params.profile.code, name: params.profile.name}); mem.taskProfiles = [...mem.taskProfiles]; context.selectedTaskProfile=null;"
                    },
                    {
                        "name": "onModified"
                    }
                ],
                "deleteProfile": [
                    {
                        "js": "mem.taskProfiles.splice(mem.taskProfiles.indexOf(context.selectedTaskProfile, 1)); mem.taskProfiles = [...mem.taskProfiles];"
                    },
                    {
                        "name": "onModified"
                    }
                ],
                "onSelectionChanged": {
                    "js": "console.log('onSelectionChanged', arguments['0']); context.selectedTaskProfile = selectedRow;"
                }
            }
        }
    },
    "methods": {
        "getList": {
            "sql": {
                "params": []
            },
            "script": {
                "params": [],
                "py": "from apng_core.workplace.models import User, UserWorkplace\nfrom apng_core.aoa.services import applyFilterModel, applyFilterModel2\n\nquery = User.objects\n\nif parameters.get('id'):\n    query = query.filter(id=parameters['id'])\nelse:\n    request = parameters.get('request')\n    filterModel = request.get('filterModel') if request else None\n    filterModel2 = request.get('filterModel2') if request else None\n        \n    if filterModel or filterModel2:\n        if filterModel:\n            query = applyFilterModel(query, filterModel)\n        if filterModel2:\n            query = applyFilterModel2(query, filterModel2)\n    else:\n        query = query.all()\n    \n    query = query.order_by('code')\n    \n    if request:\n        query = query[request['startRow']:request['endRow']]\n        \nfrom django.db.models import prefetch_related_objects\nprefetch_related_objects(query, 'workplaces')\n        \ndata = []\nfor u in query:\n    d = {\n        'id': u.id.__str__(),\n        'code': u.code,\n        'name': u.name,\n    }\n    \n    workplaces = UserWorkplace.objects.filter(username=u.code)\n    \n    d['workplaces'] = ', '.join([x.workplace.name for x in workplaces])\n    \n    data.append(d)\n\n\n"
            }
        },
        "delete": {
            "sql": {
                "params": []
            },
            "script": {
                "params": [],
                "py": "from django.db import transaction\nfrom django.conf import settings\nfrom apng_core.workplace.models import User, UserWorkplace\n\nwith transaction.atomic(using=settings.APPS_DB[User._meta.app_label]):\n    user = User.objects.get(id=parameters.get('id')) \n    UserWorkplace.objects.filter(username=user.code).delete()\n    user.delete()\n\n"
            }
        },
        "get": {
            "sql": {
                "params": []
            },
            "script": {
                "params": [],
                "py": "from apng_core.workplace.models import User, UserWorkplace\n\nif parameters.get('id'):\n    flt = {'id': parameters['id']}\nelif parameters.get('code'):\n    flt = {'code': parameters['code']}\nelse:\n    raise UserException('Для получения пользователя нужно передеать id или code')\n    \nu = User.objects.get(**flt)\n\n\ndata = {\n    'id': u.id.__str__(),\n    'code': u.code,\n    'name': u.name,\n    'settings': u.data if u.data is not None else {},\n    'fixedPosition': u.fixedPosition,\n    'keepSession': u.keepSession,\n    'workplaces': [{\n        'id': x.id.__str__(),\n        'workplace_id': x.workplace.id.__str__(),\n        'code': x.workplace.code,\n        'name': x.workplace.name,\n    } for x in UserWorkplace.objects.filter(username=u.code)]\n}\n"
            }
        },
        "save": {
            "sql": {
                "params": []
            },
            "script": {
                "params": [],
                "py": "from apng_core.workplace.models import User, Workplace, UserWorkplace\nfrom django.db import transaction\nfrom django.conf import settings\n\nwith transaction.atomic(using=settings.APPS_DB['workplace']):\n    try:\n        user_id = parameters.get('id')\n        if user_id:\n            user = User.objects.get(id=user_id)\n        else:\n            user = User();\n            \n        user.code = parameters.get('code')\n        user.name = parameters.get('name')\n        user.data = parameters.get('settings')\n        \n        user.fixedPosition = parameters.get('fixedPosition')\n        user.keepSession = parameters.get('keepSession')\n    \n        user.save()\n        \n        UserWorkplace.objects.filter(username=user.code).delete()\n        for wp in parameters.get('workplaces'):\n            userWorkplace = UserWorkplace()\n            userWorkplace.user = user\n            userWorkplace.username = user.code\n            \n            if wp.get('workplace_id'):\n                userWorkplace.workplace_id = wp['workplace_id']\n            else:\n                wkp = Workplace.objects.get(code=wp['code'])\n                userWorkplace.workplace_id = wkp.id\n            \n            userWorkplace.save()\n            \n        data = {\n            'id': user.id.__str__()\n        }\n    except Exception as e:\n        raise UserException({\n            'message': 'Ошибка сохранения пользователя\\n%s' % e,\n            'trace': traceback.format_exc(),\n        })\n\n"
            }
        }
    },
    "lists": {
        "default": {
            "id": "id",
            "columns": {
                "code": {
                    "title": "Код",
                    "width": 200
                },
                "name": {
                    "title": "Наименование",
                    "width": 300
                },
                "workplaces": {
                    "title": "Рабочие места",
                    "flex": 1
                }
            },
            "actions": [
                {
                    "title": "Обновить",
                    "icon": "refresh",
                    "mini": true,
                    "command": {
                        "type": "standard",
                        "call": "refresh"
                    }
                },
                {
                    "title": "Создать",
                    "icon": "add",
                    "mini": true,
                    "command": {
                        "type": "task",
                        "call": "/aoa/ObjectTask",
                        "title": "Новый пользователь",
                        "params": {
                            "object": "user",
                            "form": "editUserTask"
                        }
                    }
                },
                {
                    "title": "Открыть",
                    "icon": "view",
                    "mini": true,
                    "command": {
                        "type": "task",
                        "call": "/aoa/ObjectTask",
                        "title$": "`Пользователь ${$listRow.code}`",
                        "params": {
                            "object": "user",
                            "form": "editUserTask",
                            "userId$": "$listRow.id"
                        }
                    },
                    "disabled": "!$listRow"
                },
                {
                    "title": "Удалить",
                    "icon": "delete",
                    "mini": "true",
                    "confirm": {
                        "message$": "`Удалить пользователя ${$listRow.code}, ${$listRow.name} ?`",
                        "yes": "Да",
                        "no": "Нет"
                    },
                    "command": {
                        "type": "standard",
                        "call": "delete"
                    },
                    "disabled": "!$listRow"
                },
                {
                    "title": "Инструменты",
                    "split": true,
                    "actions": [
                        {
                            "title": "Пакеты",
                            "command": {
                                "type": "js",
                                "js": "frontend.dialog({object: 'package', form: 'objectPackageDialog', mem: {}, params: {objectId: $listRow.code, model: 'workplace.User'}, context: {}})"
                            },
                            "disabled": "!$listRow"
                        },
                        {
                            "title": "История",
                            "command": {
                                "type": "task",
                                "title$": "`История объекта: ${$listRow.code}`",
                                "call": "/aoa/ObjectTask",
                                "params": {
                                    "object": "aos.ModifiedObjects",
                                    "form": "historyTask",
                                    "model": "workplace.User",
                                    "objectId$": "$listRow.code"
                                }
                            },
                            "disabled": "!$listRow"
                        }
                    ]
                }
            ],
            "filter": {
                "form": {
                    "style": {
                        "width": "360px",
                        "overflow": "hidden",
                        "paddingRight": "0px"
                    },
                    "title": "Фильтр",
                    "className": "panel vertical",
                    "$": {
                        "@fields": {
                            "className": "vertical",
                            "style": {
                                "paddingTop": "8px",
                                "paddingRight": "8px",
                                "overflowY": "auto",
                                "flexGrow": 1
                            },
                            "$": {
                                "code": {
                                    "label": "Код",
                                    "control": "TextEdit"
                                },
                                "name": {
                                    "label": "Нименование",
                                    "control": "TextEdit"
                                }
                            }
                        },
                        "@buttons": {
                            "className": "horizontal",
                            "$": {
                                "btnClear": {
                                    "control": "Button",
                                    "label": "Очистить",
                                    "controlProps": {
                                        "variant": "outlined",
                                        "color": "primary"
                                    },
                                    "action": {
                                        "name": "clean"
                                    }
                                },
                                "btnApply": {
                                    "control": "Button",
                                    "label": "Применить",
                                    "controlProps": {
                                        "variant": "contained",
                                        "color": "primary"
                                    },
                                    "action": {
                                        "js": "actions.apply(mem);",
                                        "params": {
                                            "disableUpdate": true
                                        }
                                    }
                                }
                            }
                        }
                    },
                    "actions": {
                        "clean": {
                            "jsScript": "Object.keys(mem).forEach(function(key) { delete mem[key]; });"
                        }
                    }
                }
            }
        }
    },
    "references": {}
}