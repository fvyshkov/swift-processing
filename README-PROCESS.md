# Система управления состояниями и действиями по документам

## Обзор

Данная система предназначена для управления жизненным циклом документов различных типов с поддержкой состояний, действий и связей между документами.

## Архитектура системы

### 1. Справочник типов документов

В документе используется код типа документа для идентификации его категории.

**Структура:**
- **Код типа** — уникальный идентификатор типа документа
- **Наименование** — человекочитаемое название типа
- **Ресурс реализующий показ документа по ключу** — эндпоинт для отображения документа. Поддерживается интеграция с внешними системами (например, Колвир)

### 2. Справочник состояний документов

Каждое состояние привязано к определенному типу документа.

**Структура:**
- **Ссылка на тип** — связь с типом документа
- **Код состояния** — уникальный идентификатор состояния (используется в поле состояния документа)
- **Наименование** — название состояния
- **Цвет на списках документов** — визуальное представление (ссылка на справочник цветов)
- **Флаг доступности коррекции документа** — разрешает/запрещает редактирование документа в данном состоянии
- **Флаг доступности удаления документа** — разрешает/запрещает удаление документа в данном состоянии

### 3. Справочник действий

Определяет доступные операции над документами в зависимости от их состояния.

**Структура:**
- **Ссылка на тип** — привязка к типу документа
- **Деталь ссылок на состояния** — множественные состояния, в которых доступно данное действие
- **Наименование** — название действия
- **Условия доступности для состояния** — условия на основе полей списка или детализации документов
- **Пиктограмма** — иконка для отображения на панели действий или стандартная с текстом
- **Ресурс реализующий действие** — эндпоинт, принимающий параметры (ключ документа и его тип). Запускает BPMN-сценарий, который может содержать клиентские задачи и сервисы. Статус документа может изменяться внутри процесса автоматически или оставаться неизменным.

## Принципы работы

### Жизненный цикл документа

1. **Импорт документа**
   - При импорте документа (например, входящего платежа) устанавливается начальное состояние
   - На основе флагов состояния определяется доступность стандартных кнопок «Коррекция» и «Удаление»
   - Отображаются дополнительные действия, доступные для текущего состояния документа

2. **Выполнение действий**
   - Действия приводят к изменению состояния документа
   - Пример: действие «Создать документ в АБС»
     - Запускается клиентская задача с формой
     - Пользователь выбирает счета Дт/Кт из Колвира
     - Заполняются дополнительные атрибуты
     - Вызывается процедура создания документа в АБС

### Журнал выполненных действий

Для каждого документа ведется журнал всех выполненных действий.

**Структура записи журнала:**
- Уникальный ключ записи журнала
- Ссылка на ключ документа
- Тип документа
- Кто выполнил действие
- Когда выполнено
- Какое действие выполнено
- Список дополнительных атрибутов (код атрибута + значение)
- Деталь порожденных документов:
  - Ссылка на журнал
  - Тип порожденного документа
  - Ключ порожденного документа

**Примеры использования журнала:**
- Сохранение ссылок на созданные документы в АБС
- Трассировка истории изменений документа

### Связи между документами

Реализован механизм связей между документами по аналогии с `T_PROCINH` из Колвир, но без использования физических ссылок внутри базы данных.

**Структура связей:**
- Ссылка на родительский документ + тип родительского документа
- Ссылка на связанный документ + тип связанного документа

**Возможности:**
- Связь документов, находящихся в разных системах
- Гиперссылки между документами
- Навигация по цепочке связанных документов

**Примеры связей:**

Для входящего платежа можно просмотреть:
- Связанную строку выписки
- Подтверждения дебета/кредита
- Сделку в дилинге
- Порожденный документ в Колвире
- Историю переписки (типы 195, 199)
- Документы, созданные в результате выполнения действий

**Особенности работы со связями:**

1. **Связывание документов**
   - При работе с входящей перепиской можно запустить действие
   - На клиентской форме связать документ с платежом
   - Поиск документа по прикладному атрибуту (референсный ключ или идентификатор во внешней системе)
   - Запись связи в аналог `T_PROCINH`

2. **Отображение связей**
   - Связи видны как со стороны списка платежей, так и со стороны списка переписок
   - Стандартный механизм показа связанных документов
   - По типу документа определяется способ его отображения
   - Детализация документа загружается по его ключу

3. **Удаление документов**
   - При удалении документа автоматически удаляются все связанные ссылки

### Интеграция с внешними системами

**Колвир (Kolvir):**
- Ключ документа сохраняется в виде: `DEP_ID + разделитель + ID`
- Отсутствие двойных ключей в системе
- Использование сквозного ключа на всю систему

## Преимущества архитектуры

- ✅ Гибкая настройка жизненного цикла документов без изменения кода
- ✅ Поддержка интеграции с множеством внешних систем
- ✅ Полная трассируемость действий и изменений
- ✅ Универсальный механизм связей между документами
- ✅ Масштабируемость и расширяемость системы
- ✅ Независимость от физической структуры БД

## Технические детали

### Ключи документов

- **Внутренние документы** — используется сквозная нумерация
- **Внешние системы** — композитные ключи (например, `DEP_ID+ID` для Колвир)
- **Универсальность** — один механизм для всех типов документов

### BPMN-интеграция

Система предполагает использование BPMN-движка для реализации сложных бизнес-процессов:
- Клиентские задачи (формы для пользователя)
- Сервисные задачи (автоматические операции)
- Автоматическое изменение состояний документов

## Словарь терминов

- **Тип документа** — категория документа (платеж, выписка, переписка и т.д.)
- **Состояние документа** — текущий статус в жизненном цикле
- **Действие** — операция, которую можно выполнить над документом
- **Журнал действий** — история всех операций с документом
- **Связь документов** — отношение родитель-потомок или ассоциация между документами
- **АБС** — Автоматизированная банковская система
- **Колвир (Kolvir)** — внешняя система учета

