# Process Condition Implementation Guide

## Overview
This guide describes how to implement conditional state transitions in the process management system by adding a Python script field to process operations that can dynamically determine the target state based on document attributes.

## Implementation Steps

### 1. Add New Field to Process Operations Table

**File to modify:** `/Users/fvyshkov/PROJECTS/swift-processing/swift.objects/ao/swiftIncome.json`
**Method:** `DB_CREATE_FULL`
**Location:** In the `CREATE TABLE public.process_operation` statement

**Action:** Add the following column after the `to_state` column:
```sql
move_to_state_script text,  -- Python script for conditional state transition
```

**Also add comment:**
```sql
COMMENT ON COLUMN public.process_operation.move_to_state_script IS
    'Python script that returns the target state ID based on document attributes';
```

### 2. Update Process Operation Form

**File to modify:** `/Users/fvyshkov/PROJECTS/swift-processing/swift.objects/ao/processManagement.json`
**Location:** In the `forms.editOperation` section

**Action:** Add new field to the form after the `to_state` field:
```json
"move_to_state_script": {
    "label": "Move to State (Python)",
    "control": "TextArea",
    "style": {
        "height": "200px",
        "fontFamily": "monospace"
    },
    "placeholder": "# Return state ID based on params\n# Available: params (dict with document attributes)\n# Example:\n# if params.get('amount', 0) > 1000000:\n#     return 'PROCESSED' # STATE CODE"
}
```
Make sure that this code come to the field without \n but with normal line ends


### 4. Update runOperation Method

**File to modify:** `/Users/fvyshkov/PROJECTS/swift-processing/swift.objects/ao/swiftIncome.json`
**Method:** `runOperation`

**Location:** Find the section where the operation is executed and the state transition happens

**Action:** Modify the state transition logic:
```python
# After fetching the operation details, check for move_to_state_script
if operation.get('move_to_state_script'):
    # Get document attributes based on process type
    process_type = # Get from process/operation relationship
    attributes_table = # Get from process_type.attributes_table
    
    # Fetch document attributes
    with initDbSession(database='default').cursor() as c:
        c.execute(f"""
            SELECT * FROM {attributes_table}
            WHERE id = %(doc_id)s
        """, {'doc_id': process['doc_id']})
        doc_attributes = fetchone(c)
    
    # Execute the script to determine target state
    script_context = {
        'params': doc_attributes,
        'logging': logging,
        'Decimal': Decimal,
        'datetime': datetime
    }
    
    exec(operation['move_to_state_script'], script_context)
    
    # The script should set 'to_state' in the context
    if 'to_state' in script_context:
        target_state_id = script_context['to_state']
    else:
        # Fallback to default to_state from operation
        target_state_id = operation['to_state']
    # Update process state
    c.execute("""
        UPDATE process 
        SET state_id = %(state_id)s
        WHERE id = %(process_id)s
    """, {'state_id': target_state_id, 'process_id': process_id})
```

### 6. Example Script Usage

Example `move_to_state_script` content:
```python
# Conditional state transition based on amount
amount = params.get('amount', 0)
currency = params.get('currency_code', 'USD')

# Different thresholds for different currencies
thresholds = {
    'USD': 1000000,
    'EUR': 900000,
    'GBP': 800000
}

threshold = thresholds.get(currency, 1000000)

if amount > threshold:
    to_state = 'high_value_approval_state_id'
elif amount > threshold / 10:
    to_state = 'standard_approval_state_id'
else:
    to_state = 'auto_approved_state_id'

# The variable 'to_state' will be used by runOperation
```
